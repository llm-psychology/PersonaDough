<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Persona Dough - Humanoid & Interview Simulator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Bootstrap 5 + Dark Theme -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #181f2e; min-height: 100vh; color: #dee4ef;}
    .navbar { background: #232846; }
    h1,h2,h3,h4 { font-family: 'Segoe UI',sans-serif; font-weight:600;}
    .humanoid-card { background: #242e50; border-radius: 14px; color: #fff; }
    .humanoid-card:hover { box-shadow:0 0 18px #5ab4ef66; transition: .26s; cursor:pointer;}
    .qa-block { background: #2c385a; border-radius:10px; margin-bottom:12px; padding:10px 16px; }
    .ai-badge { background: #60e1e6; color:#161b29; border-radius: 6px; font-weight: bold; font-size: 1em; padding: 1px 9px;}
    .spinner-border { width: 2rem; height: 2rem;}
    .btn-glow { box-shadow:0 0 18px #59d8ff66; }
    .card { height: 150px; align-items: stretch;}
    .card-selected { border:2.5px solid #65eaff;}
    .list-inline button { background:none; border:none; color:#85b8fa;}
    .list-inline button.active, .list-inline button:focus {color:#fff; font-weight:bold;}
    .chat-message { margin-bottom: 20px; }
    .user-message { background-color: #2c3b5a; color: white; padding: 12px 16px; border-radius: 8px 8px 0 8px; align-self: flex-end; max-width: 80%; font-size: 1rem; line-height: 1.5; }
    .ai-message { background-color: #1a2436; color: #eaeef5; padding: 12px 16px; border-radius: 8px 8px 8px 0; align-self: flex-start; max-width: 80%; font-size: 1rem; line-height: 1.5; }
    .message-container { display: flex; flex-direction: column; height: 300px; overflow-y: auto; padding: 15px; background: #1e2942; border-radius: 8px; margin-bottom: 10px; }
    .message-input { border-radius: 8px; background: #2c3b5a; color: white; border: 1px solid #3a496c; }
    .message-input:focus { background: #2c3b5a; color: white; }
    #chat-modal .modal-content { background: #232846; color: white; }
    #chat-modal .modal-header { border-bottom: 1px solid #374773; }
    #chat-modal .modal-footer { border-top: 1px solid #374773; }
    /* Improved contrast for trait labels */
    .trait-label { color: #ffffff; font-weight: bold; }
    .trait-items .badge { font-size: 0.85rem; padding: 0.35em 0.65em; margin-right: 4px; margin-bottom: 4px; }
    .personality-traits .badge { background-color: #6c757d; color: white; }
    .social-abilities .badge { background-color: #0d6efd; color: white; }
    .ability-attributes .badge { background-color: #198754; color: white; }
    /* Generate button styling */
    .gen-btn { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
    .btn-generate { background: #60e1e6; color: #161b29; border: none; padding: 10px 15px; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 0 15px rgba(96, 225, 230, 0.5); transition: all 0.3s; }
    .btn-generate:hover { transform: scale(1.1); box-shadow: 0 0 20px rgba(96, 225, 230, 0.7); }
    #generate-spinner { display: none; }
    /* 修改和添加新的樣式 */
    .persona-selector {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #1a2436;
      border-radius: 8px;
    }
    .persona-selector-card {
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
      background: #232846 !important;
      color: white !important;
    }
    .persona-selector-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .persona-selector-card.card-selected {
      border: 2px solid #60e1e6;
      box-shadow: 0 0 10px rgba(96,225,230,0.5);
    }
    .persona-selector-card .card-body {
      padding: 15px;
    }
    .persona-selector-card img {
      width: 60px;
      height: 60px;
      object-fit: cover;
    }
    #dialogue-container {
      height: 500px;
      background: #1e2942;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    #persona-dialogue-modal .modal-content {
      background: #232846;
      color: white;
      min-height: 80vh;
    }
    #persona-dialogue-modal .modal-body {
      padding: 20px;
    }
    #persona-dialogue-modal .card {
      border: 1px solid #374773;
      border-radius: 10px;
    }
    #persona-dialogue-modal .form-control {
      background: #2c3b5a;
      border: 1px solid #3a496c;
      color: white;
      padding: 12px;
      font-size: 1rem;
    }
    #persona-dialogue-modal .form-label {
      color: #dee4ef;
      font-size: 1rem;
      margin-bottom: 8px;
    }
    /* 自定義滾動條樣式 */
    .persona-selector::-webkit-scrollbar {
      width: 8px;
    }
    .persona-selector::-webkit-scrollbar-track {
      background: #1a2436;
      border-radius: 4px;
    }
    .persona-selector::-webkit-scrollbar-thumb {
      background: #3a496c;
      border-radius: 4px;
    }
    .persona-selector::-webkit-scrollbar-thumb:hover {
      background: #4a5a7c;
    }
    /* 調整對話氣泡樣式 */
    .chat-message {
      margin-bottom: 20px;
    }
    .user-message, .ai-message {
      padding: 12px 16px;
      font-size: 1rem;
      line-height: 1.5;
    }
    .badge {
      font-size: 0.85rem;
      padding: 5px 10px;
    }
    
    /* 群組對話樣式 */
    #group-dialogue-modal .modal-content {
      background: #232846;
      color: white;
      max-height: 90vh;
      z-index: 1055;
      display: flex;
      flex-direction: column;
    }
    #group-dialogue-modal .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    #group-dialogue-modal .card {
      border: 1px solid #374773;
      border-radius: 10px;
    }
    #group-dialogue-modal .form-control {
      background: #2c3b5a;
      border: 1px solid #3a496c;
      color: white !important;
      padding: 12px;
      font-size: 1rem;
    }
    #group-dialogue-modal .form-control::placeholder {
      color: #a0a0a0 !important;
    }
    #group-dialogue-modal .form-label {
      color: #dee4ef !important;
      font-size: 1rem;
      margin-bottom: 8px;
    }
    #group-dialogue-modal .card-title {
      color: white !important;
    }
    #group-dialogue-modal .card-text {
      color: #dee4ef !important;
    }
    #group-dialogue-modal .text-muted {
      color: #a0a0a0 !important;
    }
    #group-dialogue-modal .form-check-label {
      color: white !important;
    }
    .group-persona-selector {
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #1a2436;
      border-radius: 8px;
      border: 2px dashed #3a496c;
      transition: all 0.3s ease;
      color: white;
    }
    .group-persona-selector.has-selections {
      border-color: #60e1e6;
      border-style: solid;
    }
    .selected-personas-display {
      background: #2c3b5a;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      min-height: 60px;
    }
    .selected-persona-badge {
      background: #60e1e6;
      color: #161b29;
      padding: 8px 12px;
      border-radius: 20px;
      margin: 5px;
      display: inline-block;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .selected-persona-badge:hover {
      background: #4ac5ca;
      transform: scale(1.05);
    }
    .selected-persona-badge .remove-btn {
      margin-left: 8px;
      font-weight: bold;
      color: #161b29;
    }
    .speaking-order-container {
      background: #1e2942;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }
    .order-item {
      background: #2c3b5a;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 5px;
      display: inline-block;
      cursor: move;
      transition: all 0.3s ease;
      border: 1px solid #3a496c;
      color: white;
    }
    .order-item:hover {
      background: #3a496c;
      transform: translateY(-2px);
    }
    .order-item.dragging {
      opacity: 0.5;
      transform: scale(1.1);
    }
    .group-dialogue-bubble {
      position: relative;
      margin-bottom: 15px;
      color: white;
    }
    .group-dialogue-bubble .speaker-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #60e1e6;
    }
    .group-dialogue-bubble .speaker-name {
      background: #60e1e6;
      color: #161b29;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 5px;
      display: inline-block;
    }
    .group-dialogue-content {
      background: #2c3b5a;
      padding: 12px 16px;
      border-radius: 8px;
      margin-left: 50px;
      position: relative;
      color: white;
    }
    .group-dialogue-content::before {
      content: '';
      position: absolute;
      left: -10px;
      top: 10px;
      width: 0;
      height: 0;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 10px solid #2c3b5a;
    }
    #group-dialogue-container {
      height: 280px;
      max-height: 280px;
      background: #1e2942;
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
      color: white;
      position: relative;
      z-index: 1;
      margin-bottom: 15px;
    }
    
    .dialogue-pool-info-card {
      background: linear-gradient(135deg, rgba(25, 135, 84, 0.15), rgba(13, 202, 240, 0.1));
      border: 1px solid rgba(25, 135, 84, 0.4);
      border-radius: 12px;
      padding: 16px;
      margin-top: 15px;
      backdrop-filter: blur(5px);
    }

    .dialogue-pool-info-card .text-success {
      color: #20c997 !important;
    }

    .dialogue-pool-info-card .text-muted {
      color: #adb5bd !important;
      line-height: 1.5;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <span class="navbar-brand mb-0 h1"><i class="bi bi-person-bounding-box"></i> Persona Dough <small class="text-secondary">| AI Humanoid Agent Demo</small></span>
    <div class="btn-group">
      <button class="btn btn-outline-info" id="open-dialogue-modal-btn">
        <i class="bi bi-chat-dots"></i> 雙人對話
      </button>
      <button class="btn btn-outline-success" id="open-group-dialogue-modal-btn">
        <i class="bi bi-people"></i> 群組對話
      </button>
    </div>
  </div>
</nav>
<div class="container">
  <h2 class="mb-4">角色清單</h2>
  <div id="humanoid-list" class="row g-4"></div>
  <hr class="my-4">
  <div id="persona-detail" style="display:none;">
    <h3>角色資料 <span class="badge ai-badge" id="persona-name"></span></h3>
    <div class="mb-3" id="persona-brief"></div>
    <button class="btn btn-info btn-glow" id="start-interview-btn">和這個角色對談</button>
  </div>
  <hr>
  <div id="interview-section" style="display:none;">
    <h3 class="mb-3">與 <span id="interview-persona-name"></span> 的對談記錄</h3>
    <div id="qa-list"></div>
    <div id="loading-spinner" class="text-center my-3" style="display:none;">
      <div class="spinner-border" role="status"></div>
      <span class="text-info ms-2">AI generating interview...</span>
    </div>
  </div>
</div>



<!-- Chat Modal -->
<div class="modal fade" id="chat-modal" tabindex="-1" aria-labelledby="chat-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chat-modal-label">與 <span id="chat-persona-name"></span> 對談</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="message-container" id="message-container">
          <!-- Messages will be added here dynamically -->
        </div>
        <form id="chat-form" class="d-flex">
          <input type="text" class="form-control message-input me-2" id="message-input" placeholder="請輸入訊息..." required>
          <button type="submit" class="btn btn-primary h2">送出</button>
        </form>
      </div>
      <div class="modal-footer">
        <div id="chat-loading-spinner" class="text-center" style="display:none;">
          <div class="spinner-border spinner-border-sm text-info" role="status"></div>
          <span class="text-info ms-2">回覆處理中...</span>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    <button type="button" id="reset-conversation-btn" class="btn btn-warning">重置對話</button>
    </div>
  </div>
</div>

<!-- 在 Chat Modal 後面添加新的 Persona Dialogue Modal -->
<div class="modal fade" id="persona-dialogue-modal" tabindex="-1" aria-labelledby="persona-dialogue-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="persona-dialogue-modal-label">角色對話</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-dark h-100">
              <div class="card-body">
                <h6 class="card-title mb-3">選擇第一個角色</h6>
                <div class="persona-selector" id="persona1-selector"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-dark h-100">
              <div class="card-body">
                <h6 class="card-title mb-3">選擇第二個角色</h6>
                <div class="persona-selector" id="persona2-selector"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-8">
            <label for="initial-topic" class="form-label">初始對話主題</label>
            <input type="text" class="form-control message-input" id="initial-topic" value="你好，很高興認識你">
          </div>
          <div class="col-md-4">
            <label for="num-rounds" class="form-label">對話回合數</label>
            <input type="number" class="form-control message-input" id="num-rounds" value="5" min="1" max="10">
          </div>
        </div>
        <div class="message-container" id="dialogue-container">
          <!-- 對話內容將在這裡動態添加 -->
        </div>
      </div>
      <div class="modal-footer">
        <div id="dialogue-loading-spinner" class="text-center" style="display:none;">
          <div class="spinner-border spinner-border-sm text-info" role="status"></div>
          <span class="text-info ms-2">對話生成中...</span>
        </div>
        <button type="button" class="btn btn-primary" id="start-dialogue-btn">開始對話</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<!-- 群組對話模態框 -->
<div class="modal fade" id="group-dialogue-modal" tabindex="-1" aria-labelledby="group-dialogue-modal-label" aria-hidden="true" style="z-index: 1060;">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="group-dialogue-modal-label">
          <i class="bi bi-people"></i> 群組對話
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <!-- 左側：角色選擇 -->
          <div class="col-md-6">
            <div class="card bg-dark h-100">
              <div class="card-body">
                <h6 class="card-title mb-3">
                  <i class="bi bi-person-plus"></i> 選擇參與對話的角色 (2-10人)
                </h6>
                
                <!-- 已選擇的角色顯示區域 -->
                <div class="selected-personas-display" id="selected-personas-display">
                  <small class="text-muted">請從下方選擇角色...</small>
                </div>
                
                <!-- 角色選擇器 -->
                <div class="group-persona-selector" id="group-persona-selector">
                  <!-- 角色卡片將在這裡動態添加 -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- 右側：設定選項 -->
          <div class="col-md-6">
            <div class="card bg-dark h-100">
              <div class="card-body">
                <h6 class="card-title mb-3">
                  <i class="bi bi-gear"></i> 對話設定
                </h6>
                
                <div class="mb-3">
                  <label for="group-initial-topic" class="form-label">初始對話主題</label>
                  <input type="text" class="form-control message-input" id="group-initial-topic" 
                         value="大家好，很高興認識各位" placeholder="輸入對話主題...">
                </div>
                
                <div class="mb-3">
                  <label for="group-num-rounds" class="form-label">對話回合數</label>
                  <input type="number" class="form-control message-input" id="group-num-rounds" 
                         value="5" min="1" max="15">
                  <small class="text-muted">使用動態對話池，角色會根據興趣自由發言</small>
                </div>
                
                <div class="dialogue-pool-info-card">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-chat-heart text-success me-2"></i>
                    <strong class="text-success">智能對話池模式</strong>
                  </div>
                  <p class="small text-muted mb-0">
                    • 角色會根據話題興趣和個性決定是否發言<br>
                    • 無需固定順序，對話更自然流暢<br>
                    • 避免強制發言，讓討論更有機地發展
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 對話顯示區域 -->
        <div class="row">
          <div class="col-12">
            <div class="card bg-dark" style="max-height: 450px;">
              <div class="card-body">
                <h6 class="card-title mb-3">
                  <i class="bi bi-chat-square-text"></i> 群組對話內容
                </h6>
                <div id="group-dialogue-container">
                  <div class="text-center text-muted">
                    <i class="bi bi-chat-square-dots"></i>
                    <p class="mt-2">選擇角色並點擊「開始群組對話」來開始...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <div id="group-dialogue-loading-spinner" class="text-center" style="display:none;">
          <div class="spinner-border spinner-border-sm text-success" role="status"></div>
          <span class="text-success ms-2">群組對話生成中...</span>
        </div>
        <button type="button" class="btn btn-success" id="start-group-dialogue-btn">
          <i class="bi bi-play-circle"></i> 開始群組對話
        </button>
        <button type="button" class="btn btn-warning" id="clear-group-dialogue-btn" style="display: none;">
          <i class="bi bi-arrow-clockwise"></i> 清除對話
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap & Icons -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script>
const apiBase = ""; // same host
let currentPersonaId = null;
let chatHistory = [];
let selectedPersona1 = null;
let selectedPersona2 = null;
let dialogueSessionId = null;

// 群組對話相關變數
let selectedGroupPersonas = [];
let groupDialogueSessionId = null;
// 發言順序相關代碼已移除，現在使用動態對話池模式


// Add this event handler in the setupChatForm function or in window.onload
document.getElementById('reset-conversation-btn').addEventListener('click', async () => {
  if (sessionId) {
    try {
      await fetch(`${apiBase}/interviews/${sessionId}`, {
        method: 'DELETE'
      });
      sessionId = null;
      document.getElementById('message-container').innerHTML = '';
      addMessageToChat(`您好！我是${document.getElementById('chat-persona-name').innerText} 可以問我一些有的沒的`, false);
    } catch (error) {
      console.error("Failed to reset conversation:", error);
    }
  }
});

async function fetchHumanoids() {
  const resp = await fetch(apiBase + "/humanoids");
  const data = await resp.json();
  return data.humanoids ?? [];
}

async function fetchHumanoidById(id) {
  const resp = await fetch(apiBase + `/humanoids/${id}`);
  const data = await resp.json();
  return data.humanoid ?? {};
}

async function generateAgent() {
  const container = document.getElementById('humanoid-list');
  const spinnerCard = document.createElement('div');
  spinnerCard.className = 'col-md-4';
  spinnerCard.id = 'generating-card';
  spinnerCard.innerHTML = `
      <div class="card humanoid-card mb-2" id="generate-agent-card">
        <div class="card-body">
          <div class="p-3 d-flex justify-content-center align-items-center" style="height: 100%;">
            <div class="spinner-border text-info" role="status"></div>
            <span class="ms-2">生成中...<br>最多耗時3分鐘</span>
            <img src="" class="img-fluid rounded-circle">
          </div>
        </div>
      </div>
  `;

  // 移除舊的 generate card，換成 spinner
  const oldCard = document.getElementById('generate-agent-card')?.parentElement;
  if (oldCard) oldCard.remove();
  container.appendChild(spinnerCard);

  try {
    const resp = await fetch(apiBase + "/generate", {
      method: "POST",
      headers: {'Content-Type': 'application/json'}
    });

    if (!resp.ok) throw new Error("生成角色失敗");

    const data = await resp.json();
    const humanoids = await fetchHumanoids();
    renderHumanoidList(humanoids);
    showToast("成功生成新角色！");
  } 
  catch (err) {
    alert("生成角色失敗，請再試一次。");
    console.error(err);
    spinnerCard.innerHTML = `
      <div class="card humanoid-card mb-2" id="generate-agent-card">
        <div class="card-body">
          <div class="p-3 d-flex justify-content-center align-items-center" style="height: 100%;">
            <span class="ms-2 text-danger">發生錯誤</span>
            <img src="" class="img-fluid rounded-circle">
          </div>
        </div>
      </div>
    `;
    
    setTimeout(async function () {
      const humanoids = await fetchHumanoids();
      renderHumanoidList(humanoids);
    }, 3000); // 單位是毫秒（ms），1000 ms = 1 秒

  }
}

function showToast(message, type = 'success') {
  if (!document.getElementById('toast-container')) {
    const toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.className = 'position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '1080';
    document.body.appendChild(toastContainer);
  }
  
  const toastId = `toast-${Date.now()}`;
  const toastHtml = `
    <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">通知</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body bg-${type} text-white">
        ${message}
      </div>
    </div>
  `;
  
  document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

async function startInterview(personaId, numRounds = 6) {
  document.getElementById('loading-spinner').style.display = '';
  const resp = await fetch(apiBase + "/interviews", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ persona_id: personaId, num_rounds: numRounds, static_interview_data: "" })
  });
  document.getElementById('loading-spinner').style.display = 'none';
  if (!resp.ok) {
    alert("代理訪談產生失敗");
    return [];
  }
  const data = await resp.json();
  return data.qa_pairs ?? [];
}

// Update this function
async function sendChatMessage(message) {
  document.getElementById('chat-loading-spinner').style.display = '';
  try {
    const resp = await fetch(apiBase + "/interviews", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        persona_id: currentPersonaId, 
        num_rounds: 1, 
        static_interview_data: message,
        session_id: sessionId  // Add this line to pass the session ID
      })
    });
    
    if (!resp.ok) {
      throw new Error("回覆失敗");
    }
    
    const data = await resp.json();
    // Store the session ID from the response
    sessionId = data.session_id;  // Add this line to save the session ID
    return data.qa_pairs[0]?.a;
  } 
  catch (error) {
    console.error("Chat error:", error);
    return "抱歉，發生錯誤，請再試一次。";
  } 
  finally {
    document.getElementById('chat-loading-spinner').style.display = 'none';
  }
}

function addMessageToChat(content, isUser = false) {
  const messageContainer = document.getElementById('message-container');
  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message ' + (isUser ? 'd-flex justify-content-end' : 'd-flex justify-content-start');
  
  const messageBubble = document.createElement('div');
  messageBubble.className = isUser ? 'user-message' : 'ai-message';
  messageBubble.innerText = content;
  
  messageElement.appendChild(messageBubble);
  messageContainer.appendChild(messageElement);
  messageContainer.scrollTop = messageContainer.scrollHeight;
  
  // Add to chat history
  chatHistory.push({
    role: isUser ? 'user' : 'assistant',
    content: content
  });
}

function setupChatForm() {
  const form = document.getElementById('chat-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessageToChat(message, true);
    input.value = '';
    
    // Get AI response
    const response = await sendChatMessage(message);
    
    // Add AI response to chat
    addMessageToChat(response, false);
  });
}

function renderHumanoidList(humanoids) {
  const container = document.getElementById('humanoid-list');
  container.innerHTML = '';
  
  // 把資料庫的東西渲染到前端卡片上
  humanoids.forEach(h => {
    const card = document.createElement('div');
    card.className = 'col-md-4';
    card.innerHTML = `
      <div class="card humanoid-card mb-2" data-id="${h.id}">
        <div class="card-body">
          <div class="row">
            <div class="col-4">
              <img src="${apiBase}/image/${h.id}" class="img-fluid rounded-circle" alt="${h.name}" onerror="this.src='https://via.placeholder.com/80?text=無圖片'">
            </div>
            <div class="col-8">
              <h4 class="card-title">${h.name}</h4>
              <p class="card-text text-secondary">人物ID: <code>${h.id}</code></p>
            </div>
          </div>
        </div>
      </div>`;
    card.querySelector('.humanoid-card').addEventListener('click', () => {
      selectPersona(h.id, h.name);
    });
    container.appendChild(card);
  });

  // ➕ 加入「再生成一個角色」卡片
  const card = document.createElement('div');
  card.className = 'col-md-4';
  card.innerHTML = `
      <div class="card humanoid-card mb-2" id="generate-agent-card">
        <div class="card-body">
          <div class="row">
            <div class="col-4">
              <img src="" class="img-fluid rounded-circle">
              <i class="bi bi-person-plus img-fluid rounded-circle" style="height: 100%; font-size: 4rem; flex-direction: column; justify-content: center;"></i>
            </div>
            <div class="col-8 d-flex align-items-center justify-content-center">
              <h4 class="card-title text-center">再生成一個角色</h4>
            </div>
          </div>
        </div>
      </div>`;
  container.appendChild(card);
  container.querySelector('#generate-agent-card').addEventListener('click', generateAgent);

}

async function selectPersona(id, name) {
  document.querySelectorAll('.humanoid-card').forEach(el=>el.classList.remove('card-selected'));
  document.querySelector(`.humanoid-card[data-id="${id}"]`).classList.add('card-selected');
  document.getElementById("persona-detail").style.display="";
  document.getElementById("persona-name").innerText = name;
  currentPersonaId = id;
  
  const detail = await fetchHumanoidById(id);
  let html = `<ul class="list-inline">`;
  for(const [k,v] of Object.entries(detail["基本資料"]??{})) {
    html += `<li class="list-inline-item mx-2"><span class="text-info">${k}</span>: <b>${v}</b></li>`;
  }
  html += `</ul>`;
  
  // Updated styling for traits with better contrast
  html += `<div class="mt-3 trait-items personality-traits">
    <span class="trait-label">特質：</span>
    ${(detail["人格屬性"]?.["人格特質"]||[]).map(x=>`<span class="badge">${x}</span>`).join(' ')}
  </div>`;
  
  html += `<div class="mt-2 trait-items social-abilities">
    <span class="trait-label">社交能力：</span>
    ${(detail["人格屬性"]?.["社交能力"]||[]).map(x=>`<span class="badge">${x}</span>`).join(' ')}
  </div>`;
  
  html += `<div class="mt-2 trait-items ability-attributes">
    <span class="trait-label">能力屬性：</span>
    ${(detail["人格屬性"]?.["能力屬性"]||[]).map(x=>`<span class="badge">${x}</span>`).join(' ')}
  </div>`;
  
  html += `<div class="mt-3">${detail["生平故事"]||""}</div>`;
  document.getElementById("persona-brief").innerHTML = html;
  document.getElementById("start-interview-btn").onclick = () => openChatModal(id, name);
}

function openChatModal(personaId, personaName) {
  // Reset chat history and session ID
  chatHistory = [];
  sessionId = null;  // Add this line to reset the session ID
  document.getElementById('message-container').innerHTML = '';
  document.getElementById('chat-persona-name').innerText = personaName;
  
  // Show modal with profile image
  const chatModal = new bootstrap.Modal(document.getElementById('chat-modal'));
  
  // Update modal header to include profile image
  const modalHeader = document.querySelector('#chat-modal .modal-header');
  if (!modalHeader.querySelector('.profile-img')) {
    const profileImg = document.createElement('img');
    profileImg.src = `${apiBase}/image/${personaId}`;
    profileImg.className = 'profile-img rounded-circle me-2';
    profileImg.style.width = '40px';
    profileImg.style.height = '40px';
    profileImg.onerror = function() { this.src = 'https://via.placeholder.com/40?text=無圖片'; };
    const title = modalHeader.querySelector('.modal-title');
    modalHeader.insertBefore(profileImg, title);
  } else {
    modalHeader.querySelector('.profile-img').src = `${apiBase}/image/${personaId}`;
  }
  
  chatModal.show();
  
  // Add welcome message
  addMessageToChat(`您好！我是${personaName} 可以問我一些有的沒的`, false);
}

async function launchInterview(personaId, personaName) {
  document.getElementById("interview-section").style.display = "";
  document.getElementById("interview-persona-name").innerText = personaName;
  document.getElementById("qa-list").innerHTML = `<div class="qa-block text-center text-secondary">AI 訪談生成中，請稍候...</div>`;
  const qaPairs = await startInterview(personaId);
  renderQAList(qaPairs);
}

function renderQAList(qas) {
  const qaList = document.getElementById("qa-list");
  if (!qas.length) {
    qaList.innerHTML = `<div class="qa-block text-center text-warning">未取得 Q&A 訪談...</div>`;
    return;
  }
  qaList.innerHTML = "";
  qas.forEach((item, i) => {
    qaList.innerHTML += `
      <div class="qa-block">
        <div><span class="text-info">Q${i+1}：</span>${item.question || item.q}</div>
        <div><span class="text-warning">A${i+1}：</span>${item.answer || item.a}</div>
      </div>
    `;
  });
}

function setupPersonaDialogue() {
  // 設置打開對話模態框的按鈕
  document.getElementById('open-dialogue-modal-btn').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('persona-dialogue-modal'));
    modal.show();
    renderPersonaSelectors();
  });

  // 設置開始對話按鈕
  document.getElementById('start-dialogue-btn').addEventListener('click', startPersonaDialogue);
}

function setupGroupDialogue() {
  // 設置打開群組對話模態框的按鈕
  document.getElementById('open-group-dialogue-modal-btn').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('group-dialogue-modal'));
    modal.show();
    renderGroupPersonaSelector();
    resetGroupDialogue();
  });

  // 設置開始群組對話按鈕
  document.getElementById('start-group-dialogue-btn').addEventListener('click', startGroupDialogue);

  // 設置清除對話按鈕
  document.getElementById('clear-group-dialogue-btn').addEventListener('click', clearGroupDialogue);

  // 設置發言順序選項變更
  // 發言順序選項已移除，現在使用動態對話池模式
}

async function renderGroupPersonaSelector() {
  const humanoids = await fetchHumanoids();
  const selector = document.getElementById('group-persona-selector');
  
  // 清空選擇器
  selector.innerHTML = '';
  
  // 為每個角色添加卡片
  humanoids.forEach(h => {
    const card = createGroupPersonaSelectorCard(h);
    selector.appendChild(card);
  });
}

function createGroupPersonaSelectorCard(humanoid) {
  const card = document.createElement('div');
  card.className = 'card humanoid-card mb-2 persona-selector-card';
  card.dataset.id = humanoid.id;
  card.innerHTML = `
    <div class="card-body">
      <div class="row">
        <div class="col-3">
          <img src="${apiBase}/image/${humanoid.id}" class="img-fluid rounded-circle" alt="${humanoid.name}" 
               onerror="this.src='https://via.placeholder.com/60?text=無圖片'">
        </div>
        <div class="col-9">
          <h6 class="card-title">${humanoid.name}</h6>
          <p class="card-text text-secondary"><small>ID: ${humanoid.id}</small></p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="group-persona-${humanoid.id}" 
                   onchange="toggleGroupPersonaSelection('${humanoid.id}', '${humanoid.name}', this.checked)">
            <label class="form-check-label" for="group-persona-${humanoid.id}">
              選擇此角色
            </label>
          </div>
        </div>
      </div>
    </div>
  `;
  
  return card;
}

function toggleGroupPersonaSelection(personaId, personaName, isSelected) {
  const persona = { id: personaId, name: personaName };
  
  if (isSelected) {
    // 檢查是否已達到最大人數
    if (selectedGroupPersonas.length >= 10) {
      showToast('最多只能選擇10個角色', 'warning');
      document.getElementById(`group-persona-${personaId}`).checked = false;
      return;
    }
    
    // 添加到選中列表
    if (!selectedGroupPersonas.find(p => p.id === personaId)) {
      selectedGroupPersonas.push(persona);
    }
  } else {
    // 從選中列表移除
    selectedGroupPersonas = selectedGroupPersonas.filter(p => p.id !== personaId);
  }
  
  updateSelectedPersonasDisplay();
  updateGroupSelector();
}

function updateSelectedPersonasDisplay() {
  const display = document.getElementById('selected-personas-display');
  
  if (selectedGroupPersonas.length === 0) {
    display.innerHTML = '<small class="text-muted">請從下方選擇角色...</small>';
    return;
  }
  
  let html = '';
  selectedGroupPersonas.forEach(persona => {
    html += `
      <span class="selected-persona-badge" onclick="removeGroupPersona('${persona.id}')">
        ${persona.name}
        <span class="remove-btn">×</span>
      </span>
    `;
  });
  
  display.innerHTML = html;
}

function removeGroupPersona(personaId) {
  selectedGroupPersonas = selectedGroupPersonas.filter(p => p.id !== personaId);
  document.getElementById(`group-persona-${personaId}`).checked = false;
  updateSelectedPersonasDisplay();
  updateGroupSelector();
}

function updateGroupSelector() {
  const selector = document.getElementById('group-persona-selector');
  const hasSelections = selectedGroupPersonas.length > 0;
  
  if (hasSelections) {
    selector.classList.add('has-selections');
  } else {
    selector.classList.remove('has-selections');
  }
}

// 發言順序相關函數已移除，現在使用動態對話池模式

function resetGroupDialogue() {
  selectedGroupPersonas = [];
  groupDialogueSessionId = null;
  
  // 重置所有選項
  document.getElementById('group-initial-topic').value = '大家好，很高興認識各位';
  document.getElementById('group-num-rounds').value = '5';
  
  // 重置顯示
  updateSelectedPersonasDisplay();
  updateGroupSelector();
  
  // 重置對話容器
  document.getElementById('group-dialogue-container').innerHTML = `
    <div class="text-center text-muted">
      <i class="bi bi-chat-square-dots"></i>
      <p class="mt-2">選擇角色並點擊「開始群組對話」來開始...</p>
    </div>
  `;
  
  // 重置按鈕狀態
  document.getElementById('clear-group-dialogue-btn').style.display = 'none';
  
  // 重置所有選框
  document.querySelectorAll('#group-persona-selector input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
}

async function startGroupDialogue() {
  if (selectedGroupPersonas.length < 2) {
    showToast('請至少選擇2個角色進行群組對話', 'warning');
    return;
  }
  
  if (selectedGroupPersonas.length > 10) {
    showToast('最多只能選擇10個角色', 'warning');
    return;
  }
  
  const initialTopic = document.getElementById('group-initial-topic').value.trim();
  const numRounds = parseInt(document.getElementById('group-num-rounds').value);
  
  if (!initialTopic) {
    showToast('請輸入初始對話主題', 'warning');
    return;
  }
  
  // 顯示載入動畫
  document.getElementById('group-dialogue-loading-spinner').style.display = '';
  document.getElementById('group-dialogue-container').innerHTML = '';
  
  try {
    const personaIds = selectedGroupPersonas.map(p => p.id);
    
    const response = await fetch(`${apiBase}/group-dialogue`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        persona_ids: personaIds,
        num_rounds: numRounds,
        initial_topic: initialTopic,
        session_id: groupDialogueSessionId
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.detail || '群組對話生成失敗');
    }
    
    const data = await response.json();
    groupDialogueSessionId = data.session_id;
    
    // 渲染群組對話內容
    renderGroupDialogueContent(data.dialogue_rounds);
    
    // 顯示清除按鈕
    document.getElementById('clear-group-dialogue-btn').style.display = 'inline-block';
    
    showToast('群組對話生成成功！', 'success');
    
  } catch (error) {
    console.error('Group dialogue error:', error);
    showToast(error.message || '群組對話生成失敗，請重試', 'danger');
    
    // 顯示錯誤訊息
    document.getElementById('group-dialogue-container').innerHTML = `
      <div class="text-center text-danger">
        <i class="bi bi-exclamation-triangle"></i>
        <p class="mt-2">${error.message || '發生錯誤，請重試'}</p>
      </div>
    `;
  } finally {
    document.getElementById('group-dialogue-loading-spinner').style.display = 'none';
  }
}

function renderGroupDialogueContent(dialogueRounds) {
  const container = document.getElementById('group-dialogue-container');
  container.innerHTML = '';
  
  dialogueRounds.forEach(round => {
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'group-dialogue-bubble';
    
    bubbleDiv.innerHTML = `
      <div class="d-flex align-items-start">
        <img src="${apiBase}/image/${round.speaker_id}" class="speaker-avatar me-3" 
             alt="${round.speaker}" onerror="this.src='https://via.placeholder.com/40?text=${round.speaker}'">
        <div class="flex-grow-1">
          <div class="speaker-name">${round.speaker}</div>
          <div class="group-dialogue-content">
            ${round.content}
          </div>
          <small class="text-muted">第 ${round.round} 輪</small>
        </div>
      </div>
    `;
    
    container.appendChild(bubbleDiv);
  });
  
  container.scrollTop = container.scrollHeight;
}

async function clearGroupDialogue() {
  if (groupDialogueSessionId) {
    try {
      await fetch(`${apiBase}/group-dialogue/${groupDialogueSessionId}`, {
        method: 'DELETE'
      });
      showToast('群組對話歷史已清除', 'info');
    } catch (error) {
      console.error('Failed to clear group dialogue:', error);
    }
  }
  
  // 重置對話容器但保持角色選擇
  document.getElementById('group-dialogue-container').innerHTML = `
    <div class="text-center text-muted">
      <i class="bi bi-chat-square-dots"></i>
      <p class="mt-2">點擊「開始群組對話」來重新開始...</p>
    </div>
  `;
  
  groupDialogueSessionId = null;
  document.getElementById('clear-group-dialogue-btn').style.display = 'none';
}

async function renderPersonaSelectors() {
  const humanoids = await fetchHumanoids();
  const selector1 = document.getElementById('persona1-selector');
  const selector2 = document.getElementById('persona2-selector');
  
  // 清空選擇器
  selector1.innerHTML = '';
  selector2.innerHTML = '';
  
  // 為每個選擇器添加角色卡片
  humanoids.forEach(h => {
    const card1 = createPersonaSelectorCard(h, 'persona1');
    const card2 = createPersonaSelectorCard(h, 'persona2');
    selector1.appendChild(card1);
    selector2.appendChild(card2);
  });
}

function createPersonaSelectorCard(humanoid, selectorType) {
  const card = document.createElement('div');
  card.className = 'card humanoid-card mb-2 persona-selector-card';
  card.dataset.id = humanoid.id;
  card.innerHTML = `
    <div class="card-body">
      <div class="row">
        <div class="col-4">
          <img src="${apiBase}/image/${humanoid.id}" class="img-fluid rounded-circle" alt="${humanoid.name}" 
               onerror="this.src='https://via.placeholder.com/80?text=無圖片'">
        </div>
        <div class="col-8">
          <h6 class="card-title">${humanoid.name}</h6>
          <p class="card-text text-secondary"><small>ID: ${humanoid.id}</small></p>
        </div>
      </div>
    </div>
  `;
  
  card.addEventListener('click', () => selectPersonaForDialogue(humanoid, selectorType));
  return card;
}

function selectPersonaForDialogue(humanoid, selectorType) {
  // 移除其他卡片的選中狀態
  document.querySelectorAll(`#${selectorType}-selector .persona-selector-card`).forEach(card => {
    card.classList.remove('card-selected');
  });
  
  // 選中當前卡片
  const selectedCard = document.querySelector(`#${selectorType}-selector .persona-selector-card[data-id="${humanoid.id}"]`);
  selectedCard.classList.add('card-selected');
  
  // 更新選中的角色
  if (selectorType === 'persona1') {
    selectedPersona1 = humanoid;
  } else {
    selectedPersona2 = humanoid;
  }
}

async function startPersonaDialogue() {
  if (!selectedPersona1 || !selectedPersona2) {
    showToast('請選擇兩個角色進行對話', 'warning');
    return;
  }
  
  if (selectedPersona1.id === selectedPersona2.id) {
    showToast('請選擇不同的角色進行對話', 'warning');
    return;
  }
  
  const initialTopic = document.getElementById('initial-topic').value.trim();
  const numRounds = parseInt(document.getElementById('num-rounds').value);
  
  if (!initialTopic) {
    showToast('請輸入初始對話主題', 'warning');
    return;
  }
  
  // 顯示載入動畫
  document.getElementById('dialogue-loading-spinner').style.display = '';
  document.getElementById('dialogue-container').innerHTML = '';
  
  try {
    const response = await fetch(`${apiBase}/persona-dialogue`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        persona1_id: selectedPersona1.id,
        persona2_id: selectedPersona2.id,
        num_rounds: numRounds,
        initial_topic: initialTopic,
        session_id: dialogueSessionId
      })
    });
    
    if (!response.ok) {
      throw new Error('對話生成失敗');
    }
    
    const data = await response.json();
    dialogueSessionId = data.session_id;
    
    // 渲染對話內容
    renderDialogueContent(data.dialogue_rounds);
    
  } catch (error) {
    console.error('Dialogue error:', error);
    showToast('對話生成失敗，請重試', 'danger');
  } finally {
    document.getElementById('dialogue-loading-spinner').style.display = 'none';
  }
}

function renderDialogueContent(dialogueRounds) {
  const container = document.getElementById('dialogue-container');
  container.innerHTML = '';
  
  dialogueRounds.forEach(round => {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message d-flex ' + 
      (round.speaker === selectedPersona1.name ? 'justify-content-start' : 'justify-content-end');
    
    const messageBubble = document.createElement('div');
    messageBubble.className = round.speaker === selectedPersona1.name ? 'ai-message' : 'user-message';
    
    const speakerSpan = document.createElement('span');
    speakerSpan.className = 'badge bg-info me-2';
    speakerSpan.textContent = round.speaker;
    
    messageBubble.appendChild(speakerSpan);
    messageBubble.appendChild(document.createTextNode(round.content));
    messageDiv.appendChild(messageBubble);
    container.appendChild(messageDiv);
  });
  
  container.scrollTop = container.scrollHeight;
}

window.onload = async () => {
  document.getElementById("interview-section").style.display = "none";
  document.getElementById("persona-detail").style.display = "none";
  const humanoids = await fetchHumanoids();
  renderHumanoidList(humanoids);
  setupChatForm();
  setupPersonaDialogue();
  setupGroupDialogue();
}
</script>
</body>
</html>