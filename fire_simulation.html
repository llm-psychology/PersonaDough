<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«ç½ç¾å ´æ¨¡æ“¬ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "header header header"
                "map status controls"
                "logs logs logs";
            grid-template-rows: 60px 1fr 300px;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-area: header;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-radius: 8px;
        }

        .map-container {
            grid-area: map;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .status-panel {
            grid-area: status;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .controls-panel {
            grid-area: controls;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logs-panel {
            grid-area: logs;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        /* åœ°åœ–æ¨£å¼ */
        .floor-plan {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            height: 400px;
            border: 2px solid #34495e;
            padding: 10px;
            background: #ecf0f1;
        }

        .room {
            border: 2px solid #34495e;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #2ecc71;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 5px;
        }

        .room.smoke { 
            background: #f39c12; 
            color: white;
        }
        .room.fire { 
            background: #e74c3c; 
            animation: fire-flicker 1s infinite alternate;
            color: white;
        }
        .room.exit { 
            background: #3498db; 
            border-color: #2980b9;
            border-width: 3px;
            color: white;
        }

        @keyframes fire-flicker {
            0% { background: #e74c3c; }
            100% { background: #c0392b; }
        }

        .room-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .room-agents {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .agent-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #34495e;
            color: white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
        }

        .agent-icon.escaped { background: #27ae60; }
        .agent-icon.injured { background: #e74c3c; }
        .agent-icon.panic { background: #f39c12; }

        /* æ§åˆ¶é¢æ¿æ¨£å¼ */
        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .control-group input, .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .btn:hover { background: #2980b9; }
        .btn.danger { background: #e74c3c; }
        .btn.danger:hover { background: #c0392b; }
        .btn.success { background: #27ae60; }
        .btn.success:hover { background: #229954; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* ç‹€æ…‹é¢æ¿æ¨£å¼ */
        .agent-status {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            background: #f9f9f9;
            font-size: 12px;
        }

        .agent-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .agent-details {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-normal { background: #2ecc71; }
        .status-panic { background: #f39c12; }
        .status-injured { background: #e74c3c; }
        .status-escaped { background: #3498db; }

        /* æ—¥èªŒæ¨£å¼ */
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .log-timestamp {
            color: #7f8c8d;
            font-weight: bold;
        }

        .log-event { color: #e74c3c; }
        .log-action { color: #3498db; }
        .log-move { color: #27ae60; }

        .connection-status {
            margin-left: 20px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .connected { background: #2ecc71; color: white; }
        .disconnected { background: #e74c3c; color: white; }
        .connecting { background: #f39c12; color: white; }

        @media (max-width: 768px) {
            body {
                grid-template-areas: 
                    "header"
                    "controls"
                    "map"
                    "status"
                    "logs";
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto auto auto auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¥ ç«ç½ç¾å ´æ¨¡æ“¬ç³»çµ±</h1>
        <div style="margin-left: auto; display: flex; align-items: center;">
            <span id="simulation-status">æº–å‚™ä¸­...</span>
            <span id="tick-counter" style="margin-left: 20px;">æ™‚é–“: 0</span>
            <div id="connection-status" class="connection-status disconnected">æœªé€£æ¥</div>
        </div>
    </div>

    <div class="map-container">
        <h3>å»ºç¯‰å¹³é¢åœ–</h3>
        <div class="floor-plan" id="floor-plan">
            <!-- æˆ¿é–“ä½ˆå±€ -->
            <div class="room" id="room-è‡¥å®¤A">
                <div class="room-name">è‡¥å®¤A</div>
                <div class="room-agents" id="agents-è‡¥å®¤A"></div>
            </div>
            <div class="room" id="room-è‡¥å®¤B">
                <div class="room-name">è‡¥å®¤B</div>
                <div class="room-agents" id="agents-è‡¥å®¤B"></div>
            </div>
            <div class="room" id="room-è‡¥å®¤C">
                <div class="room-name">è‡¥å®¤C</div>
                <div class="room-agents" id="agents-è‡¥å®¤C"></div>
            </div>
            <div class="room" id="room-æµ´å®¤">
                <div class="room-name">æµ´å®¤</div>
                <div class="room-agents" id="agents-æµ´å®¤"></div>
            </div>
            <div class="room" id="room-èµ°å»Š" style="grid-column: span 4;">
                <div class="room-name">èµ°å»Š</div>
                <div class="room-agents" id="agents-èµ°å»Š"></div>
            </div>
            <div class="room" id="room-å®¢å»³" style="grid-column: span 2;">
                <div class="room-name">å®¢å»³</div>
                <div class="room-agents" id="agents-å®¢å»³"></div>
            </div>
            <div class="room" id="room-å»šæˆ¿">
                <div class="room-name">å»šæˆ¿</div>
                <div class="room-agents" id="agents-å»šæˆ¿"></div>
            </div>
            <div class="room exit" id="room-å¤§é–€">
                <div class="room-name">å¤§é–€(å‡ºå£)</div>
                <div class="room-agents" id="agents-å¤§é–€"></div>
            </div>
        </div>
    </div>

    <div class="status-panel">
        <h3>ä»£ç†äººç‹€æ…‹</h3>
        <div id="agents-status">
            <div style="color: #7f8c8d; font-style: italic;">ç­‰å¾…æ¨¡æ“¬é–‹å§‹...</div>
        </div>
    </div>

    <div class="controls-panel">
        <h3>æ¨¡æ“¬æ§åˆ¶</h3>
        
        <div class="control-group">
            <label for="num-agents">ä»£ç†äººæ•¸é‡:</label>
            <input type="number" id="num-agents" value="5" min="2" max="10">
        </div>

        <div class="control-group">
            <label for="simulation-speed">æ¨¡æ“¬é€Ÿåº¦:</label>
            <select id="simulation-speed">
                <option value="2.0">æ…¢é€Ÿ (2ç§’)</option>
                <option value="1.0" selected>æ­£å¸¸ (1ç§’)</option>
                <option value="0.5">å¿«é€Ÿ (0.5ç§’)</option>
            </select>
        </div>

        <button class="btn success" id="start-btn" onclick="startSimulation()">é–‹å§‹æ¨¡æ“¬</button>
        <button class="btn" id="pause-btn" onclick="pauseSimulation()" disabled>æš«åœ</button>
        <button class="btn danger" id="stop-btn" onclick="stopSimulation()" disabled>åœæ­¢æ¨¡æ“¬</button>
        
        <div id="simulation-stats" style="margin-top: 15px; font-size: 12px;">
            <div>é€ƒç”Ÿç‡: <span id="escape-rate">-</span></div>
            <div>å—å‚·ç‡: <span id="injury-rate">-</span></div>
            <div>æ¨¡æ“¬æ™‚é•·: <span id="simulation-duration">-</span></div>
        </div>
    </div>

    <div class="logs-panel">
        <h3>äº‹ä»¶æ—¥èªŒ <button onclick="clearLogs()" style="float: right; padding: 2px 8px; font-size: 10px;">æ¸…é™¤</button></h3>
        <div id="event-logs">
            <div style="color: #7f8c8d; font-style: italic;">äº‹ä»¶æ—¥èªŒå°‡åœ¨é€™è£¡é¡¯ç¤º...</div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let simulationId = null;
        let simulationRunning = false;
        let pollingInterval = null;
        let currentTick = 0;
        
        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = `connection-status ${status}`;
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'å·²é€£æ¥';
                    break;
                case 'connecting':
                    statusElement.textContent = 'é€£æ¥ä¸­';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'æœªé€£æ¥';
                    break;
            }
        }

        // é–‹å§‹æ¨¡æ“¬
        async function startSimulation() {
            const numAgents = parseInt(document.getElementById('num-agents').value);
            const simulationSpeed = parseFloat(document.getElementById('simulation-speed').value);
            
            try {
                // æ›´æ–° UI ç‹€æ…‹
                document.getElementById('start-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('stop-btn').disabled = false;
                document.getElementById('simulation-status').textContent = 'å•Ÿå‹•ä¸­...';
                updateConnectionStatus('connecting');
                
                console.log('ç™¼é€å•Ÿå‹•è«‹æ±‚:', { num_agents: numAgents, simulation_speed: simulationSpeed });
                
                const response = await fetch('/start-fire-simulation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        num_agents: numAgents,
                        max_rounds: 20,
                        simulation_speed: simulationSpeed
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP éŒ¯èª¤è©³æƒ…:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\nè©³æƒ…: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('å•Ÿå‹•å›æ‡‰:', result);
                
                simulationId = result.simulation_id;
                simulationRunning = true;
                currentTick = 0;
                
                document.getElementById('simulation-status').textContent = 'æ¨¡æ“¬ä¸­...';
                addLogEntry(`æ¨¡æ“¬å·²å•Ÿå‹• (ID: ${simulationId})`);
                
                // é–‹å§‹è¼ªè©¢æ›´æ–°
                startPolling();
                
            } catch (error) {
                console.error('å•Ÿå‹•æ¨¡æ“¬å¤±æ•—:', error);
                alert(`å•Ÿå‹•æ¨¡æ“¬å¤±æ•—: ${error.message}`);
                resetUI();
            }
        }

        // é–‹å§‹è¼ªè©¢æ›´æ–°
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            console.log('é–‹å§‹è¼ªè©¢æ¨¡æ“¬ç‹€æ…‹');
            updateConnectionStatus('connected');
            addLogEntry('é–‹å§‹è¼ªè©¢æ¨¡æ“¬ç‹€æ…‹');
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            pollSimulationStatus();
            
            // è¨­å®šå®šæ™‚è¼ªè©¢ (æ¯500ms)
            pollingInterval = setInterval(() => {
                if (simulationRunning) {
                    pollSimulationStatus();
                } else {
                    stopPolling();
                }
            }, 500);
        }
        
        // è¼ªè©¢æ¨¡æ“¬ç‹€æ…‹
        async function pollSimulationStatus() {
            if (!simulationId) return;
            
            try {
                const response = await fetch(`/fire-simulation/${simulationId}/status`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('è¼ªè©¢ç²å¾—è³‡æ–™:', data);
                
                // è½‰æ›ç‚ºèˆ‡åŸå§‹ SSE æ ¼å¼ç›¸åŒçš„çµæ§‹
                const simulationData = {
                    tick: data.tick,
                    status: data.status,
                    agents: data.agents_data || [],
                    rooms: data.rooms_data || {},
                    events: data.events || [],
                    finished: data.finished || false,
                    stats: data.final_stats
                };
                
                updateSimulationState(simulationData);
                
            } catch (error) {
                console.error('è¼ªè©¢å¤±æ•—:', error);
                updateConnectionStatus('disconnected');
                
                // å¦‚æœé€£çºŒå¤±æ•—ï¼Œåœæ­¢è¼ªè©¢
                setTimeout(() => {
                    if (simulationRunning) {
                        updateConnectionStatus('connecting');
                        addLogEntry('å˜—è©¦é‡æ–°é€£æ¥...');
                    }
                }, 2000);
            }
        }
        
        // åœæ­¢è¼ªè©¢
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('è¼ªè©¢å·²åœæ­¢');
                updateConnectionStatus('disconnected');
            }
        }

        // æ›´æ–°æ¨¡æ“¬ç‹€æ…‹
        function updateSimulationState(data) {
            console.log('æ›´æ–°æ¨¡æ“¬ç‹€æ…‹:', data);
            
            currentTick = data.tick;
            document.getElementById('tick-counter').textContent = `æ™‚é–“: ${currentTick}`;
            
            // æ›´æ–°æˆ¿é–“ç‹€æ…‹
            if (data.rooms) {
                Object.entries(data.rooms).forEach(([roomName, roomData]) => {
                    updateRoomState(roomName, roomData);
                });
            }
            
            // æ›´æ–°ä»£ç†äººç‹€æ…‹
            if (data.agents) {
                updateAgentsStatus(data.agents);
                updateAgentsOnMap(data.agents);
            }
            
            // æ·»åŠ äº‹ä»¶æ—¥èªŒ
            if (data.events && data.events.length > 0) {
                data.events.forEach(event => {
                    addLogEntry(event);
                });
            }
            
            // æª¢æŸ¥æ¨¡æ“¬æ˜¯å¦çµæŸ
            if (data.finished) {
                simulationRunning = false;
                document.getElementById('simulation-status').textContent = 'æ¨¡æ“¬å®Œæˆ';
                addLogEntry('æ¨¡æ“¬å®Œæˆï¼');
                
                if (data.stats) {
                    updateFinalStats(data.stats);
                }
                
                resetUI();
            }
        }

        // æ›´æ–°æˆ¿é–“ç‹€æ…‹
        function updateRoomState(roomName, roomData) {
            const roomElement = document.getElementById(`room-${roomName}`);
            if (!roomElement) return;
            
            // ç§»é™¤æ‰€æœ‰ç‹€æ…‹é¡åˆ¥
            roomElement.classList.remove('fire', 'smoke', 'exit');
            
            // æ ¹æ“šæˆ¿é–“ç‹€æ…‹æ·»åŠ å°æ‡‰é¡åˆ¥
            if (roomData.on_fire) {
                roomElement.classList.add('fire');
            } else if (roomData.smoke) {
                roomElement.classList.add('smoke');
            } else if (roomData.is_exit) {
                roomElement.classList.add('exit');
            }
        }

        // æ›´æ–°åœ°åœ–ä¸Šçš„ä»£ç†äºº
        function updateAgentsOnMap(agents) {
            // æ¸…ç©ºæ‰€æœ‰æˆ¿é–“çš„ä»£ç†äºº
            document.querySelectorAll('.room-agents').forEach(container => {
                container.innerHTML = '';
            });
            
            // é‡æ–°æ”¾ç½®ä»£ç†äºº
            agents.forEach(agent => {
                const container = document.getElementById(`agents-${agent.location}`);
                if (container) {
                    const agentIcon = document.createElement('div');
                    agentIcon.className = 'agent-icon';
                    agentIcon.textContent = agent.name.charAt(0);
                    
                    // æ ¹æ“šç‹€æ…‹è¨­å®šæ¨£å¼
                    if (agent.escaped) {
                        agentIcon.classList.add('escaped');
                    } else if (agent.injured) {
                        agentIcon.classList.add('injured');
                    } else if (agent.panic_level > 70) {
                        agentIcon.classList.add('panic');
                    }
                    
                    agentIcon.title = `${agent.name} (å¥åº·: ${agent.health}, ææ…Œ: ${agent.panic_level})`;
                    container.appendChild(agentIcon);
                }
            });
        }

        // æ›´æ–°ä»£ç†äººç‹€æ…‹é¢æ¿
        function updateAgentsStatus(agents) {
            const statusContainer = document.getElementById('agents-status');
            statusContainer.innerHTML = '';
            
            agents.forEach(agent => {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'agent-status';
                
                let statusClass = 'status-normal';
                let statusText = 'æ­£å¸¸';
                
                if (agent.escaped) {
                    statusClass = 'status-escaped';
                    statusText = 'å·²é€ƒç”Ÿ';
                } else if (agent.injured) {
                    statusClass = 'status-injured';
                    statusText = 'å—å‚·';
                } else if (agent.panic_level > 70) {
                    statusClass = 'status-panic';
                    statusText = 'ææ…Œ';
                }
                
                statusDiv.innerHTML = `
                    <div class="agent-name">
                        <span class="status-indicator ${statusClass}"></span>
                        ${agent.name}
                    </div>
                    <div class="agent-details">
                        ä½ç½®: ${agent.location} | å¥åº·: ${agent.health}/100<br>
                        ææ…Œ: ${agent.panic_level}/100 | ç‹€æ…‹: ${statusText}
                    </div>
                `;
                
                statusContainer.appendChild(statusDiv);
            });
        }

        // æ·»åŠ æ—¥èªŒæ¢ç›®
        function addLogEntry(event) {
            const logsContainer = document.getElementById('event-logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let logClass = 'log-action';
            if (event.includes('ç’°å¢ƒ') || event.includes('ç«') || event.includes('ç…™éœ§')) {
                logClass = 'log-event';
            } else if (event.includes('ç§»å‹•') || event.includes('é€ƒç”Ÿ')) {
                logClass = 'log-move';
            }
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${currentTick}]</span>
                <span class="${logClass}">${event}</span>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // æ›´æ–°æœ€çµ‚çµ±è¨ˆ
        function updateFinalStats(stats) {
            document.getElementById('escape-rate').textContent = `${(stats.escape_rate * 100).toFixed(1)}%`;
            document.getElementById('injury-rate').textContent = `${(stats.injury_rate * 100).toFixed(1)}%`;
            document.getElementById('simulation-duration').textContent = `${stats.total_ticks} å›åˆ`;
        }

        // æš«åœæ¨¡æ“¬
        async function pauseSimulation() {
            if (!simulationId) return;
            
            try {
                const response = await fetch(`/fire-simulation/${simulationId}/control?action=pause`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    addLogEntry('æ¨¡æ“¬å·²æš«åœ');
                }
            } catch (error) {
                console.error('æš«åœå¤±æ•—:', error);
            }
        }

        // åœæ­¢æ¨¡æ“¬
        async function stopSimulation() {
            if (!simulationId) return;
            
            try {
                const response = await fetch(`/fire-simulation/${simulationId}/control?action=stop`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    addLogEntry('æ¨¡æ“¬å·²åœæ­¢');
                    simulationRunning = false;
                    resetUI();
                    stopPolling();
                }
            } catch (error) {
                console.error('åœæ­¢å¤±æ•—:', error);
            }
        }

        // é‡ç½® UI
        function resetUI() {
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('stop-btn').disabled = true;
            updateConnectionStatus('disconnected');
            stopPolling();
        }

        // æ¸…é™¤æ—¥èªŒ
        function clearLogs() {
            document.getElementById('event-logs').innerHTML = '';
        }

        // æª¢æŸ¥æ¨¡æ“¬ç‹€æ…‹
        async function checkSimulationStatus() {
            if (!simulationId) return;
            
            try {
                const response = await fetch(`/fire-simulation/${simulationId}/status`);
                if (response.ok) {
                    const status = await response.json();
                    console.log('æ¨¡æ“¬ç‹€æ…‹æª¢æŸ¥:', status);
                    addLogEntry(`ç‹€æ…‹æª¢æŸ¥: ${status.status} (tick: ${status.tick})`);
                } else {
                    console.error('ç‹€æ…‹æª¢æŸ¥å¤±æ•—:', response.status);
                    addLogEntry(`ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                console.error('ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤:', error);
                addLogEntry(`ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤: ${error.message}`);
            }
        }

        // é é¢è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆ');
            addLogEntry('ç³»çµ±å·²æº–å‚™å°±ç·’');
        });
    </script>
</body>
</html> 