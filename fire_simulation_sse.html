<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÅ´ÁÅΩÁèæÂ†¥Ê®°Êì¨Á≥ªÁµ± (SSEÁâàÊú¨)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "header header header"
                "map status controls"
                "logs logs logs";
            grid-template-rows: 60px 1fr 300px;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-area: header;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-radius: 8px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #27ae60;
            animation: none;
        }

        .status-indicator.connecting {
            background: #f39c12;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .map-container {
            grid-area: map;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .status-panel {
            grid-area: status;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .controls-panel {
            grid-area: controls;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logs-panel {
            grid-area: logs;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        /* Âú∞ÂúñÊ®£Âºè */
        .floor-plan {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            height: 400px;
            border: 2px solid #34495e;
            padding: 10px;
            background: #ecf0f1;
        }

        .room {
            border: 2px solid #34495e;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #2ecc71;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 5px;
        }

        .room.smoke { 
            background: #95a5a6; 
            border-color: #7f8c8d;
        }
        
        .room.fire { 
            background: #e74c3c; 
            border-color: #c0392b;
            animation: fireFlicker 0.5s infinite alternate;
        }
        
        .room.exit { 
            background: #3498db; 
            border-color: #2980b9;
        }

        @keyframes fireFlicker {
            0% { background: #e74c3c; }
            100% { background: #c0392b; }
        }

        .room-label {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .agents-in-room {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            align-items: center;
        }

        .agent-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #2c3e50;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
            position: relative;
        }

        .agent-dot.panicked {
            border-color: #e74c3c;
            background: #ffecec;
            animation: shake 0.3s infinite;
        }

        .agent-dot.injured {
            border-color: #f39c12;
            background: #fff3cd;
        }

        .agent-dot.escaped {
            border-color: #27ae60;
            background: #d4edda;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-1px); }
            75% { transform: translateX(1px); }
        }

        /* ÊéßÂà∂Èù¢ÊùøÊ®£Âºè */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* ÁãÄÊÖãÈù¢ÊùøÊ®£Âºè */
        .agent-status {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .agent-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .agent-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .agent-action {
            font-size: 11px;
            color: #34495e;
            font-style: italic;
            background: #e8f4f8;
            padding: 3px 6px;
            border-radius: 3px;
            margin-top: 5px;
        }

        /* Êó•Ë™åÊ®£Âºè */
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #3498db;
            background: #f8f9fa;
            font-size: 13px;
        }

        .log-entry.system {
            border-left-color: #27ae60;
        }

        .log-entry.event {
            border-left-color: #f39c12;
        }

        .log-entry.error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .log-timestamp {
            color: #7f8c8d;
            font-size: 11px;
            margin-right: 10px;
        }

        .simulation-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .simulation-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
            color: #34495e;
        }

        .info-value {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî• ÁÅ´ÁÅΩÁèæÂ†¥Ê®°Êì¨Á≥ªÁµ± (SSEÁâàÊú¨)</h1>
        <div class="connection-status">
            <div class="status-indicator" id="connectionIndicator"></div>
            <span id="connectionStatus">Êú™ÈÄ£Êé•</span>
        </div>
    </div>

    <div class="map-container">
        <h2>Âª∫ÁØâÂπ≥Èù¢Âúñ</h2>
        <div class="floor-plan" id="floorPlan">
            <!-- ÊàøÈñìÂ∞áÈÄöÈÅéJavaScriptÂãïÊÖãÁîüÊàê -->
        </div>
    </div>

    <div class="status-panel">
        <h2>‰ª£ÁêÜ‰∫∫ÁãÄÊÖã</h2>
        <div id="agentStatusList">
            <!-- ‰ª£ÁêÜ‰∫∫ÁãÄÊÖãÂ∞áÈÄöÈÅéJavaScriptÂãïÊÖãÁîüÊàê -->
        </div>
    </div>

    <div class="controls-panel">
        <div class="control-group">
            <h3>Ê®°Êì¨Ë®≠ÂÆö</h3>
            <div class="input-group">
                <label for="numAgents">‰ª£ÁêÜ‰∫∫Êï∏Èáè:</label>
                <input type="number" id="numAgents" min="1" max="20" value="8">
            </div>
            <div class="input-group">
                <label for="fireRoom">Ëµ∑ÁÅ´ÊàøÈñì:</label>
                <select id="fireRoom">
                    <option value="A1">ÊàøÈñì A1</option>
                    <option value="A2">ÊàøÈñì A2</option>
                    <option value="A3">ÊàøÈñì A3</option>
                    <option value="B1">ÊàøÈñì B1</option>
                    <option value="B2">ÊàøÈñì B2</option>
                    <option value="B3">ÊàøÈñì B3</option>
                    <option value="C1">ÊàøÈñì C1</option>
                    <option value="C2">ÊàøÈñì C2</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="startSimulation()">ÈñãÂßãÊ®°Êì¨</button>
        </div>

        <div class="control-group">
            <h3>Ê®°Êì¨ÊéßÂà∂</h3>
            <button class="btn btn-warning" id="pauseBtn" onclick="pauseSimulation()" disabled>Êö´ÂÅú</button>
            <button class="btn btn-success" id="resumeBtn" onclick="resumeSimulation()" disabled>ÁπºÁ∫å</button>
            <button class="btn btn-danger" id="stopBtn" onclick="stopSimulation()" disabled>ÂÅúÊ≠¢</button>
        </div>

        <div class="simulation-info" id="simulationInfo" style="display: none;">
            <h3>Ê®°Êì¨Ë≥áË®ä</h3>
            <div class="info-item">
                <span class="info-label">Ê®°Êì¨ID:</span>
                <span class="info-value" id="simId">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Áï∂ÂâçTick:</span>
                <span class="info-value" id="currentTick">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">ÁãÄÊÖã:</span>
                <span class="info-value" id="simStatus">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">SSEÈÄ£Êé•:</span>
                <span class="info-value" id="sseStatus">Êú™ÈÄ£Êé•</span>
            </div>
        </div>
    </div>

    <div class="logs-panel">
        <h2>‰∫ã‰ª∂Êó•Ë™å</h2>
        <div id="eventLogs">
            <!-- ‰∫ã‰ª∂Êó•Ë™åÂ∞áÈÄöÈÅéJavaScriptÂãïÊÖãÁîüÊàê -->
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let simulationId = null;
        let simulationRunning = false;
        let eventSource = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 2000; // 2Áßí

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÁÅ´ÁÅΩÊ®°Êì¨Á≥ªÁµ±ÂàùÂßãÂåñ (SSEÁâàÊú¨)');
            initializeFloorPlan();
            addLogEntry('Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê', 'system');
        });

        // ÂàùÂßãÂåñÂπ≥Èù¢Âúñ
        function initializeFloorPlan() {
            const floorPlan = document.getElementById('floorPlan');
            const rooms = [
                'A1', 'A2', 'A3', 'A4',
                'B1', 'B2', 'B3', 'B4', 
                'C1', 'C2', 'C3', 'C4'
            ];

            rooms.forEach(roomId => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room';
                roomElement.id = `room-${roomId}`;
                roomElement.innerHTML = `
                    <div class="room-label">${roomId}</div>
                    <div class="agents-in-room" id="agents-${roomId}"></div>
                `;
                
                // Ë®≠ÂÆöÂá∫Âè£ÊàøÈñì
                if (['A4', 'C4'].includes(roomId)) {
                    roomElement.classList.add('exit');
                }
                
                floorPlan.appendChild(roomElement);
            });

            console.log('Âπ≥Èù¢ÂúñÂàùÂßãÂåñÂÆåÊàê');
        }

        // ÈñãÂßãÊ®°Êì¨
        async function startSimulation() {
            const numAgents = document.getElementById('numAgents').value;
            const fireRoom = document.getElementById('fireRoom').value;

            try {
                addLogEntry(`Ê∫ñÂÇôÈñãÂßãÊ®°Êì¨ - ‰ª£ÁêÜ‰∫∫Êï∏: ${numAgents}, Ëµ∑ÁÅ´ÊàøÈñì: ${fireRoom}`, 'system');
                
                const response = await fetch('/start-fire-simulation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        num_agents: parseInt(numAgents),
                        max_rounds: 15,
                        simulation_speed: 1.0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                simulationId = data.simulation_id;
                simulationRunning = true;

                // Êõ¥Êñ∞UI
                updateSimulationInfo();
                updateControlButtons();
                
                addLogEntry(`Ê®°Êì¨Â∑≤ÈñãÂßã - ID: ${simulationId}`, 'system');
                
                // ÈñãÂßãSSEÈÄ£Êé•
                startSSEConnection();

            } catch (error) {
                console.error('ÈñãÂßãÊ®°Êì¨Â§±Êïó:', error);
                addLogEntry(`ÈñãÂßãÊ®°Êì¨Â§±Êïó: ${error.message}`, 'error');
            }
        }

        // ÈñãÂßãSSEÈÄ£Êé•
        function startSSEConnection() {
            if (!simulationId) {
                addLogEntry('ÁÑ°ÊïàÁöÑÊ®°Êì¨IDÔºåÁÑ°Ê≥ïÂª∫Á´ãSSEÈÄ£Êé•', 'error');
                return;
            }

            // ÈóúÈñâÁèæÊúâÈÄ£Êé•
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            updateConnectionStatus('connecting');
            addLogEntry(`Âª∫Á´ãSSEÈÄ£Êé•Âà∞Ê®°Êì¨ ${simulationId}...`, 'system');

            try {
                const sseUrl = `/simulation-stream/${simulationId}`;
                console.log('Âª∫Á´ãEventSourceÈÄ£Êé•:', sseUrl);
                
                eventSource = new EventSource(sseUrl);

                // ÈÄ£Êé•ÊâìÈñã‰∫ã‰ª∂
                eventSource.onopen = function(event) {
                    console.log('EventSourceÈÄ£Êé•Â∑≤ÊâìÈñã:', event);
                    updateConnectionStatus('connected');
                    reconnectAttempts = 0;
                    reconnectDelay = 2000; // ÈáçÁΩÆÂª∂ÈÅ≤
                    addLogEntry('SSEÈÄ£Êé•Âª∫Á´ãÊàêÂäü', 'system');
                };

                // ÈÄ£Êé•ÊàêÂäüÁ¢∫Ë™ç‰∫ã‰ª∂
                eventSource.addEventListener('connected', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('SSEÈÄ£Êé•Á¢∫Ë™ç:', data);
                        addLogEntry(`SSEÈÄ£Êé•Á¢∫Ë™ç: ${data.message} (${data.connection_id})`, 'system');
                    } catch (error) {
                        console.error('Ëß£ÊûêÈÄ£Êé•Á¢∫Ë™çË≥áÊñôÂ§±Êïó:', error);
                    }
                });

                // Ê®°Êì¨Êõ¥Êñ∞‰∫ã‰ª∂
                eventSource.addEventListener('simulation_update', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Êî∂Âà∞Ê®°Êì¨Êõ¥Êñ∞ tick:', data.tick);
                        updateSimulationState(data);
                    } catch (error) {
                        console.error('Ëß£ÊûêÊ®°Êì¨Ë≥áÊñôÂ§±Êïó:', error);
                        addLogEntry(`Ëß£ÊûêÊ®°Êì¨Ë≥áÊñôÂ§±Êïó: ${error.message}`, 'error');
                    }
                });

                // Ê®°Êì¨ÁµêÊùü‰∫ã‰ª∂
                eventSource.addEventListener('simulation_ended', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Ê®°Êì¨ÁµêÊùü‰∫ã‰ª∂:', data);
                        addLogEntry('Êî∂Âà∞Ê®°Êì¨ÁµêÊùü‰ø°Ëôü', 'system');
                        
                        simulationRunning = false;
                        updateControlButtons();
                        updateConnectionStatus('disconnected');
                        
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }
                    } catch (error) {
                        console.error('ËôïÁêÜÊ®°Êì¨ÁµêÊùü‰∫ã‰ª∂Â§±Êïó:', error);
                    }
                });

                // ÈåØË™§‰∫ã‰ª∂
                eventSource.addEventListener('error', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.error('SSEÈåØË™§‰∫ã‰ª∂:', data);
                        addLogEntry(`SSEÈåØË™§: ${data.error}`, 'error');
                    } catch (error) {
                        console.error('Ëß£ÊûêSSEÈåØË™§‰∫ã‰ª∂Â§±Êïó:', error);
                    }
                });

                // ÈÄöÁî®ÈåØË™§ËôïÁêÜ
                eventSource.onerror = function(event) {
                    console.error('EventSource‰∏ÄËà¨ÈåØË™§:', event);
                    console.log('EventSource readyState:', eventSource.readyState);
                    
                    updateConnectionStatus('disconnected');
                    
                    // readyState: 0=CONNECTING, 1=OPEN, 2=CLOSED
                    if (eventSource.readyState === EventSource.CLOSED) {
                        console.log('EventSourceÈÄ£Êé•Â∑≤ÈóúÈñâ');
                        
                        if (simulationRunning && reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            const delaySeconds = reconnectDelay / 1000;
                            addLogEntry(`SSEÈÄ£Êé•‰∏≠Êñ∑Ôºå${delaySeconds}ÁßíÂæåÈáçË©¶ (${reconnectAttempts}/${maxReconnectAttempts})`, 'error');
                            
                            setTimeout(() => {
                                if (simulationRunning) {
                                    startSSEConnection();
                                }
                            }, reconnectDelay);
                            
                            // ÊåáÊï∏ÈÄÄÈÅø
                            reconnectDelay = Math.min(reconnectDelay * 1.5, 10000);
                        } else if (simulationRunning) {
                            addLogEntry('SSEÈÄ£Êé•Â§±ÊïóÔºåÂ∑≤ÈÅîÊúÄÂ§ßÈáçË©¶Ê¨°Êï∏', 'error');
                            simulationRunning = false;
                            updateControlButtons();
                        }
                    }
                };

                // Êé•Êî∂ÊâÄÊúâË®äÊÅØÁöÑÂÇôÁî®ËôïÁêÜÂô®
                eventSource.onmessage = function(event) {
                    console.log('Êî∂Âà∞‰∏ÄËà¨SSEË®äÊÅØ:', event.data);
                };

            } catch (error) {
                console.error('Âª∫Á´ãSSEÈÄ£Êé•Â§±Êïó:', error);
                addLogEntry(`Âª∫Á´ãSSEÈÄ£Êé•Â§±Êïó: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
            }
        }

        // Êõ¥Êñ∞ÈÄ£Êé•ÁãÄÊÖã
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('connectionStatus');
            const sseStatus = document.getElementById('sseStatus');

            indicator.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('connected');
                    statusText.textContent = 'Â∑≤ÈÄ£Êé•';
                    if (sseStatus) sseStatus.textContent = 'Â∑≤ÈÄ£Êé•';
                    break;
                case 'connecting':
                    indicator.classList.add('connecting');
                    statusText.textContent = 'ÈÄ£Êé•‰∏≠...';
                    if (sseStatus) sseStatus.textContent = 'ÈÄ£Êé•‰∏≠...';
                    break;
                case 'disconnected':
                default:
                    statusText.textContent = 'Êú™ÈÄ£Êé•';
                    if (sseStatus) sseStatus.textContent = 'Êú™ÈÄ£Êé•';
                    break;
            }
        }

        // Êõ¥Êñ∞Ê®°Êì¨ÁãÄÊÖã
        function updateSimulationState(data) {
            if (!data) return;

            // Êõ¥Êñ∞Âü∫Êú¨Ë≥áË®ä
            document.getElementById('currentTick').textContent = data.tick || 0;
            document.getElementById('simStatus').textContent = data.status || 'Êú™Áü•';

            // Êõ¥Êñ∞Âú∞Âúñ
            updateFloorPlan(data.rooms || {}, data.agents || []);
            
            // Êõ¥Êñ∞‰ª£ÁêÜ‰∫∫ÁãÄÊÖã
            updateAgentStatus(data.agents || []);
            
            // ËôïÁêÜ‰∫ã‰ª∂
            if (data.events && data.events.length > 0) {
                data.events.forEach(event => {
                    addLogEntry(event, 'event');
                });
            }

            // Ê™¢Êü•Ê®°Êì¨ÊòØÂê¶ÁµêÊùü
            if (data.finished) {
                simulationRunning = false;
                updateControlButtons();
                if (data.stats) {
                    showFinalStats(data.stats);
                }
            }
        }

        // Êõ¥Êñ∞Âπ≥Èù¢Âúñ
        function updateFloorPlan(rooms, agents) {
            // ÈáçÁΩÆÊâÄÊúâÊàøÈñì
            document.querySelectorAll('.room').forEach(room => {
                room.className = 'room';
                const roomId = room.id.replace('room-', '');
                if (['A4', 'C4'].includes(roomId)) {
                    room.classList.add('exit');
                }
            });

            // Êõ¥Êñ∞ÊàøÈñìÁãÄÊÖã
            Object.keys(rooms).forEach(roomId => {
                const roomElement = document.getElementById(`room-${roomId}`);
                const roomData = rooms[roomId];
                
                if (roomElement && roomData) {
                    if (roomData.fire_level > 0) {
                        roomElement.classList.add('fire');
                    }
                    if (roomData.smoke_level > 0) {
                        roomElement.classList.add('smoke');
                    }
                }
            });

            // Ê∏ÖÁ©∫ÊâÄÊúâÊàøÈñìÁöÑ‰ª£ÁêÜ‰∫∫
            document.querySelectorAll('.agents-in-room').forEach(container => {
                container.innerHTML = '';
            });

            // Ê∑ªÂä†‰ª£ÁêÜ‰∫∫Âà∞Áõ∏ÊáâÊàøÈñì
            agents.forEach(agent => {
                const agentContainer = document.getElementById(`agents-${agent.current_room}`);
                if (agentContainer) {
                    const agentDot = document.createElement('div');
                    agentDot.className = 'agent-dot';
                    agentDot.textContent = agent.id;
                    agentDot.title = `${agent.name} - ÂÅ•Â∫∑: ${agent.health}% - ÊÅêÊÖå: ${agent.panic_level}%`;
                    
                    if (agent.panic_level > 70) {
                        agentDot.classList.add('panicked');
                    }
                    if (agent.health < 80) {
                        agentDot.classList.add('injured');
                    }
                    if (agent.status === 'escaped') {
                        agentDot.classList.add('escaped');
                    }
                    
                    agentContainer.appendChild(agentDot);
                }
            });
        }

        // Êõ¥Êñ∞‰ª£ÁêÜ‰∫∫ÁãÄÊÖãÈù¢Êùø
        function updateAgentStatus(agents) {
            const statusList = document.getElementById('agentStatusList');
            statusList.innerHTML = '';

            agents.forEach(agent => {
                const statusElement = document.createElement('div');
                statusElement.className = 'agent-status';
                statusElement.innerHTML = `
                    <div class="agent-name">${agent.name} (${agent.id})</div>
                    <div class="agent-info">‰ΩçÁΩÆ: ${agent.current_room}</div>
                    <div class="agent-info">ÂÅ•Â∫∑: ${agent.health}%</div>
                    <div class="agent-info">ÊÅêÊÖå: ${agent.panic_level}%</div>
                    <div class="agent-info">ÁãÄÊÖã: ${agent.status}</div>
                    <div class="agent-action">${agent.current_action || 'Á≠âÂæÖ‰∏≠...'}</div>
                `;
                statusList.appendChild(statusElement);
            });
        }

        // Êö´ÂÅúÊ®°Êì¨
        async function pauseSimulation() {
            if (!simulationId) return;

            try {
                await fetch(`/fire-simulation/${simulationId}/control?action=pause`, { method: 'POST' });
                addLogEntry('Ê®°Êì¨Â∑≤Êö´ÂÅú', 'system');
            } catch (error) {
                addLogEntry(`Êö´ÂÅúÊ®°Êì¨Â§±Êïó: ${error.message}`, 'error');
            }
        }

        // ÁπºÁ∫åÊ®°Êì¨
        async function resumeSimulation() {
            if (!simulationId) return;

            try {
                await fetch(`/fire-simulation/${simulationId}/control?action=resume`, { method: 'POST' });
                addLogEntry('Ê®°Êì¨Â∑≤ÁπºÁ∫å', 'system');
            } catch (error) {
                addLogEntry(`ÁπºÁ∫åÊ®°Êì¨Â§±Êïó: ${error.message}`, 'error');
            }
        }

        // ÂÅúÊ≠¢Ê®°Êì¨
        async function stopSimulation() {
            if (!simulationId) return;

            try {
                await fetch(`/fire-simulation/${simulationId}/control?action=stop`, { method: 'POST' });
                simulationRunning = false;
                updateControlButtons();
                
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                updateConnectionStatus('disconnected');
                addLogEntry('Ê®°Êì¨Â∑≤ÂÅúÊ≠¢', 'system');
            } catch (error) {
                addLogEntry(`ÂÅúÊ≠¢Ê®°Êì¨Â§±Êïó: ${error.message}`, 'error');
            }
        }

        // Êõ¥Êñ∞ÊéßÂà∂ÊåâÈàïÁãÄÊÖã
        function updateControlButtons() {
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (simulationRunning) {
                pauseBtn.disabled = false;
                resumeBtn.disabled = false;
                stopBtn.disabled = false;
            } else {
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }

        // Êõ¥Êñ∞Ê®°Êì¨Ë≥áË®ä
        function updateSimulationInfo() {
            const infoPanel = document.getElementById('simulationInfo');
            if (simulationId) {
                document.getElementById('simId').textContent = simulationId;
                infoPanel.style.display = 'block';
            } else {
                infoPanel.style.display = 'none';
            }
        }

        // Ê∑ªÂä†Êó•Ë™åÊ¢ùÁõÆ
        function addLogEntry(message, type = 'info') {
            const logsContainer = document.getElementById('eventLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // ÈôêÂà∂Êó•Ë™åÊï∏Èáè
            while (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // È°ØÁ§∫ÊúÄÁµÇÁµ±Ë®à
        function showFinalStats(stats) {
            const message = `
                Ê®°Êì¨ÁµêÊùü - 
                Á∏Ω‰ª£ÁêÜ‰∫∫: ${stats.total_agents || 0}, 
                ÈÄÉÁîü: ${stats.escaped_count || 0}, 
                ÂèóÂÇ∑: ${stats.injured_count || 0}, 
                ÈÄÉÁîüÁéá: ${((stats.escape_rate || 0) * 100).toFixed(1)}%
            `;
            addLogEntry(message, 'system');
        }

        // È†ÅÈù¢Âç∏ËºâÊôÇÈóúÈñâÈÄ£Êé•
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html> 