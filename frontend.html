<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Persona Dough - Humanoid & Interview Simulator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Bootstrap 5 + Dark Theme -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #181f2e; min-height: 100vh; color: #dee4ef;}
    .navbar { background: #232846; }
    h1,h2,h3,h4 { font-family: 'Segoe UI',sans-serif; font-weight:600;}
    .humanoid-card { background: #242e50; border-radius: 14px; color: #fff; }
    .humanoid-card:hover { box-shadow:0 0 18px #5ab4ef66; transition: .26s; cursor:pointer;}
    .qa-block { background: #2c385a; border-radius:10px; margin-bottom:12px; padding:10px 16px; }
    .ai-badge { background: #60e1e6; color:#161b29; border-radius: 6px; font-weight: bold; font-size: 1em; padding: 1px 9px;}
    .spinner-border { width: 2rem; height: 2rem;}
    .btn-glow { box-shadow:0 0 18px #59d8ff66; }
    .card-selected { border:2.5px solid #65eaff;}
    .list-inline button { background:none; border:none; color:#85b8fa;}
    .list-inline button.active, .list-inline button:focus {color:#fff; font-weight:bold;}
    .chat-message { margin-bottom: 15px; }
    .user-message { background-color: #2c3b5a; color: white; padding: 10px 15px; border-radius: 8px 8px 0 8px; align-self: flex-end; max-width: 80%; }
    .ai-message { background-color: #1a2436; color: #eaeef5; padding: 10px 15px; border-radius: 8px 8px 8px 0; align-self: flex-start; max-width: 80%; }
    .message-container { display: flex; flex-direction: column; height: 300px; overflow-y: auto; padding: 15px; background: #1e2942; border-radius: 8px; margin-bottom: 10px; }
    .message-input { border-radius: 8px; background: #2c3b5a; color: white; border: 1px solid #3a496c; }
    .message-input:focus { background: #2c3b5a; color: white; }
    #chat-modal .modal-content { background: #232846; color: white; }
    #chat-modal .modal-header { border-bottom: 1px solid #374773; }
    #chat-modal .modal-footer { border-top: 1px solid #374773; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <span class="navbar-brand mb-0 h1"><i class="bi bi-person-bounding-box"></i> Persona Dough <small class="text-secondary">| AI Humanoid Agent Demo</small></span>
  </div>
</nav>
<div class="container">
  <h2 class="mb-4">角色清單</h2>
  <div id="humanoid-list" class="row g-4"></div>
  <hr class="my-4">
  <div id="persona-detail" style="display:none;">
    <h3>角色資料 <span class="badge ai-badge" id="persona-name"></span></h3>
    <div class="mb-3" id="persona-brief"></div>
    <button class="btn btn-info btn-glow" id="start-interview-btn">和這個角色對談</button>
  </div>
  <hr>
  <div id="interview-section" style="display:none;">
    <h3 class="mb-3">與 <span id="interview-persona-name"></span> 的對談記錄</h3>
    <div id="qa-list"></div>
    <div id="loading-spinner" class="text-center my-3" style="display:none;">
      <div class="spinner-border" role="status"></div>
      <span class="text-info ms-2">AI generating interview...</span>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chat-modal" tabindex="-1" aria-labelledby="chat-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chat-modal-label">與 <span id="chat-persona-name"></span> 對談</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="message-container" id="message-container">
          <!-- Messages will be added here dynamically -->
        </div>
        <form id="chat-form" class="d-flex">
          <input type="text" class="form-control message-input me-2" id="message-input" placeholder="請輸入訊息..." required>
          <button type="submit" class="btn btn-primary">送出</button>
        </form>
      </div>
      <div class="modal-footer">
        <div id="chat-loading-spinner" class="text-center" style="display:none;">
          <div class="spinner-border spinner-border-sm text-info" role="status"></div>
          <span class="text-info ms-2">AI 回覆中...</span>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap & Icons -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script>
const apiBase = "http://127.0.0.1:20000"; // same host
let currentPersonaId = null;
let chatHistory = [];

async function fetchHumanoids() {
  const resp = await fetch(apiBase + "/humanoids");
  const data = await resp.json();
  return data.humanoids ?? [];
}

async function fetchHumanoidById(id) {
  const resp = await fetch(apiBase + `/humanoids/${id}`);
  const data = await resp.json();
  return data.humanoid ?? {};
}

async function startInterview(personaId, numRounds = 6) {
  document.getElementById('loading-spinner').style.display = '';
  const resp = await fetch(apiBase + "/interviews", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ persona_id: personaId, num_rounds: numRounds, static_interview_data: "" })
  });
  document.getElementById('loading-spinner').style.display = 'none';
  if (!resp.ok) {
    alert("AI 訪談產生失敗");
    return [];
  }
  const data = await resp.json();
  return data.qa_pairs ?? [];
}

async function sendChatMessage(message) {
  document.getElementById('chat-loading-spinner').style.display = '';
  try {
    const resp = await fetch(apiBase + "/interviews", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        persona_id: currentPersonaId, 
        num_rounds: 1, 
        static_interview_data: message 
      })
    });
    
    if (!resp.ok) {
      throw new Error("AI 回覆失敗");
    }
    
    const data = await resp.json();
    return data.qa_pairs[0].a;
  } 
  catch (error) {
    console.error("Chat error:", error);
    return "抱歉，發生錯誤，請再試一次。";
  } 
  finally {
    document.getElementById('chat-loading-spinner').style.display = 'none';
  }
}

function addMessageToChat(content, isUser = false) {
  const messageContainer = document.getElementById('message-container');
  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message ' + (isUser ? 'd-flex justify-content-end' : 'd-flex justify-content-start');
  
  const messageBubble = document.createElement('div');
  messageBubble.className = isUser ? 'user-message' : 'ai-message';
  messageBubble.innerText = content;
  
  messageElement.appendChild(messageBubble);
  messageContainer.appendChild(messageElement);
  messageContainer.scrollTop = messageContainer.scrollHeight;
  
  // Add to chat history
  chatHistory.push({
    role: isUser ? 'user' : 'assistant',
    content: content
  });
}

function setupChatForm() {
  const form = document.getElementById('chat-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessageToChat(message, true);
    input.value = '';
    
    // Get AI response
    const response = await sendChatMessage(message);
    
    // Add AI response to chat
    addMessageToChat(response, false);
  });
}

function renderHumanoidList(humanoids) {
  const list = document.getElementById('humanoid-list');
  list.innerHTML="";
  humanoids.forEach(h => {
    const dom = document.createElement('div');
    dom.className = "col-md-4";
    dom.innerHTML = `
      <div class="card humanoid-card mb-2" data-id="${h.id}">
        <div class="card-body">
          <h4 class="card-title">${h.name}</h4>
          <p class="card-text text-secondary">人物ID: <code>${h.id}</code></p>
        </div>
      </div>
    `;
    dom.querySelector('.humanoid-card').onclick = () => selectPersona(h.id, h.name);
    list.appendChild(dom);
  });
}

async function selectPersona(id, name) {
  document.querySelectorAll('.humanoid-card').forEach(el=>el.classList.remove('card-selected'));
  document.querySelector(`.humanoid-card[data-id="${id}"]`).classList.add('card-selected');
  document.getElementById("persona-detail").style.display="";
  document.getElementById("persona-name").innerText = name;
  currentPersonaId = id;
  
  const detail = await fetchHumanoidById(id);
  let html = `<ul class="list-inline">`;
  for(const [k,v] of Object.entries(detail["基本資料"]??{})) {
    html += `<li class="list-inline-item mx-2"><span class="text-info">${k}</span>: <b>${v}</b></li>`;
  }
  html += `</ul>`;
  html += `<div class="mt-2 text-muted">特質：${(detail["人格屬性"]?.["人格特質"]||[]).map(x=>`<span class="badge rounded-pill text-bg-secondary">${x}</span>`).join(' ')}</div>`;
  html += `<div class="mt-1 text-muted">社交能力：${(detail["人格屬性"]?.["社交能力"]||[]).map(x=>`<span class="badge bg-primary">${x}</span>`).join(' ')}</div>`;
  html += `<div class="mt-1 text-muted">能力屬性：${(detail["人格屬性"]?.["能力屬性"]||[]).map(x=>`<span class="badge bg-success">${x}</span>`).join(' ')}</div>`;
  html += `<div class="mt-2">${detail["生平故事"]||""}</div>`;
  document.getElementById("persona-brief").innerHTML = html;
  document.getElementById("start-interview-btn").onclick = () => openChatModal(id, name);
}

function openChatModal(personaId, personaName) {
  // Reset chat history
  chatHistory = [];
  document.getElementById('message-container').innerHTML = '';
  document.getElementById('chat-persona-name').innerText = personaName;
  
  // Show modal
  const chatModal = new bootstrap.Modal(document.getElementById('chat-modal'));
  chatModal.show();
  
  // Add welcome message
  addMessageToChat(`您好！我是${personaName}。很高興與您交流，請問有什麼我可以幫助您的嗎？`, false);
}

async function launchInterview(personaId, personaName) {
  document.getElementById("interview-section").style.display = "";
  document.getElementById("interview-persona-name").innerText = personaName;
  document.getElementById("qa-list").innerHTML = `<div class="qa-block text-center text-secondary">AI 訪談生成中，請稍候...</div>`;
  const qaPairs = await startInterview(personaId);
  renderQAList(qaPairs);
}

function renderQAList(qas) {
  const qaList = document.getElementById("qa-list");
  if (!qas.length) {
    qaList.innerHTML = `<div class="qa-block text-center text-warning">未取得 Q&A 訪談...</div>`;
    return;
  }
  qaList.innerHTML = "";
  qas.forEach((item, i) => {
    qaList.innerHTML += `
      <div class="qa-block">
        <div><span class="text-info">Q${i+1}：</span>${item.question || item.q}</div>
        <div><span class="text-warning">A${i+1}：</span>${item.answer || item.a}</div>
      </div>
    `;
  });
}

window.onload = async () => {
  document.getElementById("interview-section").style.display = "none";
  document.getElementById("persona-detail").style.display = "none";
  const humanoids = await fetchHumanoids();
  renderHumanoidList(humanoids);
  setupChatForm();
}
</script>
</body>
</html>