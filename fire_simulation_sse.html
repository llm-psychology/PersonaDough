<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«ç½ç¾å ´æ¨¡æ“¬ç³»çµ± (SSEç‰ˆæœ¬)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "header header header"
                "map status controls"
                "logs logs logs";
            grid-template-rows: 60px 1fr 300px;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-area: header;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-radius: 8px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #27ae60;
            animation: none;
        }

        .status-indicator.connecting {
            background: #f39c12;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .map-container {
            grid-area: map;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .status-panel {
            grid-area: status;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .controls-panel {
            grid-area: controls;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logs-panel {
            grid-area: logs;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        /* åœ°åœ–æ¨£å¼ */
        .floor-plan {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            height: 400px;
            border: 2px solid #34495e;
            padding: 10px;
            background: #ecf0f1;
        }

        .room {
            border: 2px solid #34495e;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #2ecc71;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 5px;
        }

        .room.smoke { 
            background: #95a5a6; 
            border-color: #7f8c8d;
        }
        
        .room.fire { 
            background: #e74c3c; 
            border-color: #c0392b;
            animation: fireFlicker 0.5s infinite alternate;
        }
        
        .room.exit { 
            background: #3498db; 
            border-color: #2980b9;
        }

        @keyframes fireFlicker {
            0% { background: #e74c3c; }
            100% { background: #c0392b; }
        }

        .room-label {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .agents-in-room {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            align-items: center;
        }

        .agent-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #2c3e50;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
            position: relative;
        }

        .agent-dot.panicked {
            border-color: #e74c3c;
            background: #ffecec;
            animation: shake 0.3s infinite;
        }

        .agent-dot.injured {
            border-color: #f39c12;
            background: #fff3cd;
        }

        .agent-dot.escaped {
            border-color: #27ae60;
            background: #d4edda;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-1px); }
            75% { transform: translateX(1px); }
        }

        /* æ§åˆ¶é¢æ¿æ¨£å¼ */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* ç‹€æ…‹é¢æ¿æ¨£å¼ */
        .agent-status {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .agent-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .agent-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .agent-action {
            font-size: 11px;
            color: #34495e;
            font-style: italic;
            background: #e8f4f8;
            padding: 3px 6px;
            border-radius: 3px;
            margin-top: 5px;
        }

        /* æ—¥èªŒæ¨£å¼ */
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #3498db;
            background: #f8f9fa;
            font-size: 13px;
        }

        .log-entry.system {
            border-left-color: #27ae60;
        }

        .log-entry.event {
            border-left-color: #f39c12;
        }

        .log-entry.error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .log-timestamp {
            color: #7f8c8d;
            font-size: 11px;
            margin-right: 10px;
        }

        .simulation-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .simulation-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
            color: #34495e;
        }

        .info-value {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¥ ç«ç½ç¾å ´æ¨¡æ“¬ç³»çµ± (SSEç‰ˆæœ¬)</h1>
        <div class="connection-status">
            <div class="status-indicator" id="connectionIndicator"></div>
            <span id="connectionStatus">æœªé€£æ¥</span>
        </div>
    </div>

    <div class="map-container">
        <h2>å»ºç¯‰å¹³é¢åœ–</h2>
        <div class="floor-plan" id="floorPlan">
            <!-- æˆ¿é–“å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <div class="status-panel">
        <h2>ä»£ç†äººç‹€æ…‹</h2>
        <div id="agentStatusList">
            <!-- ä»£ç†äººç‹€æ…‹å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <div class="controls-panel">
        <div class="control-group">
            <h3>æ¨¡æ“¬è¨­å®š</h3>
            <div class="input-group">
                <label for="numAgents">ä»£ç†äººæ•¸é‡:</label>
                <input type="number" id="numAgents" min="1" max="20" value="8">
            </div>
            <div class="input-group">
                <label for="fireRoom">èµ·ç«æˆ¿é–“:</label>
                <select id="fireRoom">
                    <option value="A1">æˆ¿é–“ A1</option>
                    <option value="A2">æˆ¿é–“ A2</option>
                    <option value="A3">æˆ¿é–“ A3</option>
                    <option value="B1">æˆ¿é–“ B1</option>
                    <option value="B2">æˆ¿é–“ B2</option>
                    <option value="B3">æˆ¿é–“ B3</option>
                    <option value="C1">æˆ¿é–“ C1</option>
                    <option value="C2">æˆ¿é–“ C2</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="startSimulation()">é–‹å§‹æ¨¡æ“¬</button>
        </div>

        <div class="control-group">
            <h3>æ¨¡æ“¬æ§åˆ¶</h3>
            <button class="btn btn-warning" id="pauseBtn" onclick="pauseSimulation()" disabled>æš«åœ</button>
            <button class="btn btn-success" id="resumeBtn" onclick="resumeSimulation()" disabled>ç¹¼çºŒ</button>
            <button class="btn btn-danger" id="stopBtn" onclick="stopSimulation()" disabled>åœæ­¢</button>
        </div>

        <div class="simulation-info" id="simulationInfo" style="display: none;">
            <h3>æ¨¡æ“¬è³‡è¨Š</h3>
            <div class="info-item">
                <span class="info-label">æ¨¡æ“¬ID:</span>
                <span class="info-value" id="simId">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç•¶å‰Tick:</span>
                <span class="info-value" id="currentTick">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç‹€æ…‹:</span>
                <span class="info-value" id="simStatus">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">SSEé€£æ¥:</span>
                <span class="info-value" id="sseStatus">æœªé€£æ¥</span>
            </div>
        </div>
    </div>

    <div class="logs-panel">
        <h2>äº‹ä»¶æ—¥èªŒ</h2>
        <div id="eventLogs">
            <!-- äº‹ä»¶æ—¥èªŒå°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let simulationId = null;
        let simulationRunning = false;
        let eventSource = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 2000; // 2ç§’

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç«ç½æ¨¡æ“¬ç³»çµ±åˆå§‹åŒ– (SSEç‰ˆæœ¬)');
            initializeFloorPlan();
            addLogEntry('ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'system');
        });

        // åˆå§‹åŒ–å¹³é¢åœ–
        function initializeFloorPlan() {
            const floorPlan = document.getElementById('floorPlan');
            const rooms = [
                'A1', 'A2', 'A3', 'A4',
                'B1', 'B2', 'B3', 'B4', 
                'C1', 'C2', 'C3', 'C4'
            ];

            rooms.forEach(roomId => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room';
                roomElement.id = `room-${roomId}`;
                roomElement.innerHTML = `
                    <div class="room-label">${roomId}</div>
                    <div class="agents-in-room" id="agents-${roomId}"></div>
                `;
                
                // è¨­å®šå‡ºå£æˆ¿é–“
                if (['A4', 'C4'].includes(roomId)) {
                    roomElement.classList.add('exit');
                }
                
                floorPlan.appendChild(roomElement);
            });

            console.log('å¹³é¢åœ–åˆå§‹åŒ–å®Œæˆ');
        }

        // é–‹å§‹æ¨¡æ“¬
        async function startSimulation() {
            const numAgents = document.getElementById('numAgents').value;
            const fireRoom = document.getElementById('fireRoom').value;

            try {
                addLogEntry(`æº–å‚™é–‹å§‹æ¨¡æ“¬ - ä»£ç†äººæ•¸: ${numAgents}, èµ·ç«æˆ¿é–“: ${fireRoom}`, 'system');
                
                const response = await fetch('/start-fire-simulation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        num_agents: parseInt(numAgents),
                        max_rounds: 15,
                        simulation_speed: 1.0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                simulationId = data.simulation_id;
                simulationRunning = true;

                // æ›´æ–°UI
                updateSimulationInfo();
                updateControlButtons();
                
                addLogEntry(`æ¨¡æ“¬å·²é–‹å§‹ - ID: ${simulationId}`, 'system');
                
                // é–‹å§‹SSEé€£æ¥
                startSSEConnection();

            } catch (error) {
                console.error('é–‹å§‹æ¨¡æ“¬å¤±æ•—:', error);
                addLogEntry(`é–‹å§‹æ¨¡æ“¬å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é–‹å§‹SSEé€£æ¥
        function startSSEConnection() {
            if (!simulationId) {
                addLogEntry('ç„¡æ•ˆçš„æ¨¡æ“¬IDï¼Œç„¡æ³•å»ºç«‹SSEé€£æ¥', 'error');
                return;
            }

            // é—œé–‰ç¾æœ‰é€£æ¥
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            updateConnectionStatus('connecting');
            addLogEntry(`å»ºç«‹SSEé€£æ¥åˆ°æ¨¡æ“¬ ${simulationId}...`, 'system');

            try {
                const sseUrl = `/simulation-stream/${simulationId}`;
                console.log('å»ºç«‹EventSourceé€£æ¥:', sseUrl);
                
                eventSource = new EventSource(sseUrl);

                // é€£æ¥æ‰“é–‹äº‹ä»¶
                eventSource.onopen = function(event) {
                    console.log('EventSourceé€£æ¥å·²æ‰“é–‹:', event);
                    updateConnectionStatus('connected');
                    reconnectAttempts = 0;
                    reconnectDelay = 2000; // é‡ç½®å»¶é²
                    addLogEntry('SSEé€£æ¥å»ºç«‹æˆåŠŸ', 'system');
                };

                // é€£æ¥æˆåŠŸç¢ºèªäº‹ä»¶
                eventSource.addEventListener('connected', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('SSEé€£æ¥ç¢ºèª:', data);
                        addLogEntry(`SSEé€£æ¥ç¢ºèª: ${data.message} (${data.connection_id})`, 'system');
                    } catch (error) {
                        console.error('è§£æé€£æ¥ç¢ºèªè³‡æ–™å¤±æ•—:', error);
                    }
                });

                // æ¨¡æ“¬æ›´æ–°äº‹ä»¶
                eventSource.addEventListener('simulation_update', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('æ”¶åˆ°æ¨¡æ“¬æ›´æ–° tick:', data.tick);
                        updateSimulationState(data);
                    } catch (error) {
                        console.error('è§£ææ¨¡æ“¬è³‡æ–™å¤±æ•—:', error);
                        addLogEntry(`è§£ææ¨¡æ“¬è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                    }
                });

                // æ¨¡æ“¬çµæŸäº‹ä»¶
                eventSource.addEventListener('simulation_ended', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('æ¨¡æ“¬çµæŸäº‹ä»¶:', data);
                        addLogEntry('æ”¶åˆ°æ¨¡æ“¬çµæŸä¿¡è™Ÿ', 'system');
                        
                        simulationRunning = false;
                        updateControlButtons();
                        updateConnectionStatus('disconnected');
                        
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }
                    } catch (error) {
                        console.error('è™•ç†æ¨¡æ“¬çµæŸäº‹ä»¶å¤±æ•—:', error);
                    }
                });

                // éŒ¯èª¤äº‹ä»¶
                eventSource.addEventListener('error', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.error('SSEéŒ¯èª¤äº‹ä»¶:', data);
                        addLogEntry(`SSEéŒ¯èª¤: ${data.error}`, 'error');
                    } catch (error) {
                        console.error('è§£æSSEéŒ¯èª¤äº‹ä»¶å¤±æ•—:', error);
                    }
                });

                // é€šç”¨éŒ¯èª¤è™•ç†
                eventSource.onerror = function(event) {
                    console.error('EventSourceä¸€èˆ¬éŒ¯èª¤:', event);
                    console.log('EventSource readyState:', eventSource.readyState);
                    
                    updateConnectionStatus('disconnected');
                    
                    // readyState: 0=CONNECTING, 1=OPEN, 2=CLOSED
                    if (eventSource.readyState === EventSource.CLOSED) {
                        console.log('EventSourceé€£æ¥å·²é—œé–‰');
                        
                        if (simulationRunning && reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            const delaySeconds = reconnectDelay / 1000;
                            addLogEntry(`SSEé€£æ¥ä¸­æ–·ï¼Œ${delaySeconds}ç§’å¾Œé‡è©¦ (${reconnectAttempts}/${maxReconnectAttempts})`, 'error');
                            
                            setTimeout(() => {
                                if (simulationRunning) {
                                    startSSEConnection();
                                }
                            }, reconnectDelay);
                            
                            // æŒ‡æ•¸é€€é¿
                            reconnectDelay = Math.min(reconnectDelay * 1.5, 10000);
                        } else if (simulationRunning) {
                            addLogEntry('SSEé€£æ¥å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸', 'error');
                            simulationRunning = false;
                            updateControlButtons();
                        }
                    }
                };

                // æ¥æ”¶æ‰€æœ‰è¨Šæ¯çš„å‚™ç”¨è™•ç†å™¨
                eventSource.onmessage = function(event) {
                    console.log('æ”¶åˆ°ä¸€èˆ¬SSEè¨Šæ¯:', event.data);
                };

            } catch (error) {
                console.error('å»ºç«‹SSEé€£æ¥å¤±æ•—:', error);
                addLogEntry(`å»ºç«‹SSEé€£æ¥å¤±æ•—: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
            }
        }

        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('connectionStatus');
            const sseStatus = document.getElementById('sseStatus');

            indicator.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('connected');
                    statusText.textContent = 'å·²é€£æ¥';
                    if (sseStatus) sseStatus.textContent = 'å·²é€£æ¥';
                    break;
                case 'connecting':
                    indicator.classList.add('connecting');
                    statusText.textContent = 'é€£æ¥ä¸­...';
                    if (sseStatus) sseStatus.textContent = 'é€£æ¥ä¸­...';
                    break;
                case 'disconnected':
                default:
                    statusText.textContent = 'æœªé€£æ¥';
                    if (sseStatus) sseStatus.textContent = 'æœªé€£æ¥';
                    break;
            }
        }

        // æ›´æ–°æ¨¡æ“¬ç‹€æ…‹
        function updateSimulationState(data) {
            if (!data) return;

            // æ›´æ–°åŸºæœ¬è³‡è¨Š
            document.getElementById('currentTick').textContent = data.tick || 0;
            document.getElementById('simStatus').textContent = data.status || 'æœªçŸ¥';

            // æ›´æ–°åœ°åœ–
            updateFloorPlan(data.rooms || {}, data.agents || []);
            
            // æ›´æ–°ä»£ç†äººç‹€æ…‹
            updateAgentStatus(data.agents || []);
            
            // è™•ç†äº‹ä»¶
            if (data.events && data.events.length > 0) {
                data.events.forEach(event => {
                    addLogEntry(event, 'event');
                });
            }

            // æª¢æŸ¥æ¨¡æ“¬æ˜¯å¦çµæŸ
            if (data.finished) {
                simulationRunning = false;
                updateControlButtons();
                if (data.stats) {
                    showFinalStats(data.stats);
                }
            }
        }

        // æ›´æ–°å¹³é¢åœ–
        function updateFloorPlan(rooms, agents) {
            // é‡ç½®æ‰€æœ‰æˆ¿é–“
            document.querySelectorAll('.room').forEach(room => {
                room.className = 'room';
                const roomId = room.id.replace('room-', '');
                if (['A4', 'C4'].includes(roomId)) {
                    room.classList.add('exit');
                }
            });

            // æ›´æ–°æˆ¿é–“ç‹€æ…‹
            Object.keys(rooms).forEach(roomId => {
                const roomElement = document.getElementById(`room-${roomId}`);
                const roomData = rooms[roomId];
                
                if (roomElement && roomData) {
                    if (roomData.fire_level > 0) {
                        roomElement.classList.add('fire');
                    }
                    if (roomData.smoke_level > 0) {
                        roomElement.classList.add('smoke');
                    }
                }
            });

            // æ¸…ç©ºæ‰€æœ‰æˆ¿é–“çš„ä»£ç†äºº
            document.querySelectorAll('.agents-in-room').forEach(container => {
                container.innerHTML = '';
            });

            // æ·»åŠ ä»£ç†äººåˆ°ç›¸æ‡‰æˆ¿é–“
            agents.forEach(agent => {
                const agentContainer = document.getElementById(`agents-${agent.current_room}`);
                if (agentContainer) {
                    const agentDot = document.createElement('div');
                    agentDot.className = 'agent-dot';
                    agentDot.textContent = agent.id;
                    agentDot.title = `${agent.name} - å¥åº·: ${agent.health}% - ææ…Œ: ${agent.panic_level}%`;
                    
                    if (agent.panic_level > 70) {
                        agentDot.classList.add('panicked');
                    }
                    if (agent.health < 80) {
                        agentDot.classList.add('injured');
                    }
                    if (agent.status === 'escaped') {
                        agentDot.classList.add('escaped');
                    }
                    
                    agentContainer.appendChild(agentDot);
                }
            });
        }

        // æ›´æ–°ä»£ç†äººç‹€æ…‹é¢æ¿
        function updateAgentStatus(agents) {
            const statusList = document.getElementById('agentStatusList');
            statusList.innerHTML = '';

            agents.forEach(agent => {
                const statusElement = document.createElement('div');
                statusElement.className = 'agent-status';
                statusElement.innerHTML = `
                    <div class="agent-name">${agent.name} (${agent.id})</div>
                    <div class="agent-info">ä½ç½®: ${agent.current_room}</div>
                    <div class="agent-info">å¥åº·: ${agent.health}%</div>
                    <div class="agent-info">ææ…Œ: ${agent.panic_level}%</div>
                    <div class="agent-info">ç‹€æ…‹: ${agent.status}</div>
                    <div class="agent-action">${agent.current_action || 'ç­‰å¾…ä¸­...'}</div>
                `;
                statusList.appendChild(statusElement);
            });
        }

        // æš«åœæ¨¡æ“¬
        async function pauseSimulation() {
            if (!simulationId) return;

            try {
                await fetch(`/fire-simulation/${simulationId}/control?action=pause`, { method: 'POST' });
                addLogEntry('æ¨¡æ“¬å·²æš«åœ', 'system');
            } catch (error) {
                addLogEntry(`æš«åœæ¨¡æ“¬å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ç¹¼çºŒæ¨¡æ“¬
        async function resumeSimulation() {
            if (!simulationId) return;

            try {
                await fetch(`/fire-simulation/${simulationId}/control?action=resume`, { method: 'POST' });
                addLogEntry('æ¨¡æ“¬å·²ç¹¼çºŒ', 'system');
            } catch (error) {
                addLogEntry(`ç¹¼çºŒæ¨¡æ“¬å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åœæ­¢æ¨¡æ“¬
        async function stopSimulation() {
            if (!simulationId) return;

            try {
                await fetch(`/fire-simulation/${simulationId}/control?action=stop`, { method: 'POST' });
                simulationRunning = false;
                updateControlButtons();
                
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                updateConnectionStatus('disconnected');
                addLogEntry('æ¨¡æ“¬å·²åœæ­¢', 'system');
            } catch (error) {
                addLogEntry(`åœæ­¢æ¨¡æ“¬å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
        function updateControlButtons() {
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (simulationRunning) {
                pauseBtn.disabled = false;
                resumeBtn.disabled = false;
                stopBtn.disabled = false;
            } else {
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }

        // æ›´æ–°æ¨¡æ“¬è³‡è¨Š
        function updateSimulationInfo() {
            const infoPanel = document.getElementById('simulationInfo');
            if (simulationId) {
                document.getElementById('simId').textContent = simulationId;
                infoPanel.style.display = 'block';
            } else {
                infoPanel.style.display = 'none';
            }
        }

        // æ·»åŠ æ—¥èªŒæ¢ç›®
        function addLogEntry(message, type = 'info') {
            const logsContainer = document.getElementById('eventLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // é™åˆ¶æ—¥èªŒæ•¸é‡
            while (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // é¡¯ç¤ºæœ€çµ‚çµ±è¨ˆ
        function showFinalStats(stats) {
            const message = `
                æ¨¡æ“¬çµæŸ - 
                ç¸½ä»£ç†äºº: ${stats.total_agents || 0}, 
                é€ƒç”Ÿ: ${stats.escaped_count || 0}, 
                å—å‚·: ${stats.injured_count || 0}, 
                é€ƒç”Ÿç‡: ${((stats.escape_rate || 0) * 100).toFixed(1)}%
            `;
            addLogEntry(message, 'system');
        }

        // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html> 